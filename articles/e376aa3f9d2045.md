---
title: "Juliaã®ç”Ÿæˆé–¢æ•°(@generated)ã®ä½¿ã„æ–¹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹"
emoji: "ğŸ£"
type: "tech"
topics:
  - "julia"
  - "é«˜é€ŸåŒ–"
  - "ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°"
published: true
published_at: "2021-12-19 18:55"
---

ã“ã‚Œã¯[Julia Advent Calendar 2021](https://qiita.com/advent-calendar/2021/julia)ã®20æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

å®Ÿè¡Œç’°å¢ƒã¯ä»¥ä¸‹ã§ã™ã€‚
```julia
julia> versioninfo()
Julia Version 1.7.0
Commit 3bf9d17731 (2021-11-30 12:12 UTC)
Platform Info:
  OS: Linux (x86_64-pc-linux-gnu)
  CPU: AMD Ryzen 7 2700X Eight-Core Processor
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-12.0.1 (ORCJIT, znver1)
```

# ç”Ÿæˆé–¢æ•°ã£ã¦ãªã«ï¼Ÿ
`@generated`ãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦å®šç¾©ã•ã‚Œã‚‹é–¢æ•°ã®ã“ã¨ã‚’ç”Ÿæˆé–¢æ•°ã¨å‘¼ã³ã¾ã™ï¼
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[ã“ã¡ã‚‰](https://docs.julialang.org/en/v1/manual/metaprogramming/#Generated-functions)

# æœ€åˆã®ä¾‹
## å®šç¾©
ã¾ãšã¯å…·ä½“ä¾‹ã‹ã‚‰è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```julia
julia> f(x::Real) = x+2  # å®Ÿæ•°ã«ã¯+2ã™ã‚‹
f (generic function with 1 method)

julia> f(x::Integer) = x+1  # ãŸã ã—æ•´æ•°ãªã‚‰+1ã™ã‚‹
f (generic function with 2 methods)

julia> @generated function g(x::Real)
           if x <: Integer
               return :(x+1)  # æ•´æ•°ãªã‚‰+1ã™ã‚‹
           else
               return :(x+2)  # ãã‚Œä»¥å¤–ã®å®Ÿæ•°ã§+2ã™ã‚‹
           end
       end
g (generic function with 1 method)

julia> function h(x::Real)  # Juliaã£ã½ããªã„æ›¸ãæ–¹
           if x isa Integer
               return x+1  # æ•´æ•°ãªã‚‰+1ã™ã‚‹
           else
               return x+2  # ãã‚Œä»¥å¤–ã®å®Ÿæ•°ã§+2ã™ã‚‹
           end
       end
h (generic function with 1 method)
```
ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚ˆã†ãªå®šç¾©ã«ãªã£ã¦ã„ã¾ã™ã€‚

* `f`: å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã«ã‚ˆã‚‹å®šç¾©
    * å‹ã«å¿œã˜ã¦æˆ»ã‚Šå€¤ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹æ–¹æ³•ã¨ã—ã¦æœ€ã‚‚ç”±ç·’æ­£ã—ã„ã€‚
* `g`: `@generated`ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹å®šç¾©
    * è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ãŒã€`if`æ–‡ã«ã‚ˆã£ã¦å‹ã®åˆ†å²ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
* `h`: å‹ã‚’`if`æ–‡ã§åˆ†å²ã•ã›ã¦å®šç¾©
    * `g`ã®å®šç¾©ã¨åŒã˜ã‚ˆã†ã«ã€æ„šç›´ã«`if`ã§å‹ã®åˆ†å²ã‚’ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®é–¢æ•°ãŒåŒã˜å‹•ä½œã‚’ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```julia
julia> f(1), g(1), h(1)
(2, 2, 2)

julia> f(1.0), g(1.0), h(1.0)
(3.0, 3.0, 3.0)
```
æ„å›³é€šã‚Šã€æ•´æ•°ãªã‚‰+1ã€ãã‚Œä»¥å¤–ã®å®Ÿæ•°ãªã‚‰+2ã—ã¦ã„ã¾ã™ã­ã€‚

## è©³ç´°

ã§ã¯ã€ã“ã‚Œã‚‰ã®å‹•ä½œã¯å³å¯†ã«åŒã˜ã§ã—ã‚‡ã†ã‹ï¼Ÿ
`@code_lowered`ãƒã‚¯ãƒ­ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```julia
julia> @code_lowered f(1.0)
CodeInfo(
1 â”€ %1 = x + 2
â””â”€â”€      return %1
)

julia> @code_lowered g(1.0)
CodeInfo(
    @ REPL[3]:1 within `g`
   â”Œ @ REPL[3] within `macro expansion`
1 â”€â”‚ %1 = x + 2
â””â”€â”€â”‚      return %1
   â””
)

julia> @code_lowered h(1.0)
CodeInfo(
1 â”€ %1 = x isa Main.Integer
â””â”€â”€      goto #3 if not %1
2 â”€ %3 = x + 1
â””â”€â”€      return %3
3 â”€ %5 = x + 2
â””â”€â”€      return %5
)
```

`f`ã¨`g`ã¯åŒä¸€ã®ä½ãƒ¬ãƒ™ãƒ«è¡¨ç¾ã«ãªã‚Šã¾ã—ãŸãŒã€`h`ã«ã¯ä¸è¦ãª`Integer`åˆ¤å®šãŒæ®‹ã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚æ„šç›´ãª`if`ã«ã‚ˆã‚‹å‹ã®åˆ†å²ã‚’é¿ã‘ã‚‹ã¹ãç†ç”±ãŒã“ã‚Œã§ã€`h`ã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®æœ€é©åŒ–ãŒåŠ¹ãã«ãããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã«ã‚ˆã‚‹å®šç¾©`f`ãŒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®é¢ã‹ã‚‰ã¯æœ€ã‚‚é©åˆ‡ã§ã™ã€‚

ç”Ÿæˆé–¢æ•°ã®å®šç¾©`g`ã§å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã®å®šç¾©`f`ã¨åŒç­‰ã®è¡¨ç¾ã«ãªã£ãŸã®ã¯ã©ã†ã„ã†ç†ç”±ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ç”Ÿæˆé–¢æ•°`g`ã®å®šç¾©ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
```julia
@generated function g(x::Real)
    if x <: Integer
        return :(x+1)
    else
        return :(x+2)
    end
end
```
å°‘ã—ç´›ã‚‰ã‚ã—ã„ã§ã™ãŒã€å¤‰æ•°`x`ã«ã¯3ã¤ã®å½¹å‰²ãŒã‚ã‚Šã¾ã™ã€‚
* é–¢æ•°ã®å¼•æ•°ã®`x`ã¯`Real`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹
    * `x::Real`
    * å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã®ãŸã‚ã®è¨˜è¿°ã€‚
* é–¢æ•°å®šç¾©ã®å†…éƒ¨ã§ã¯`x`ã¯`Real`ã®éƒ¨åˆ†å‹ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹
    * `x <: Integer`
    * å‹ã®åˆ†å²ã®ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹ã€‚
* æˆ»ã‚Šå€¤ã®å¼ã®å†…éƒ¨ã§ã¯`x`ã¯`Symbol`ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹
    * æˆ»ã‚Šå€¤ã¯`Expr`ã«ãªã£ã¦ã„ã‚‹ã€‚(`:(x+1)`ã‚„`:(x+2)`ãªã©)
    * ã“ã“ã§ã®`x`ã¯`:()`ã§å›²ã¾ã‚Œã¦ä¸€ã¤ã®å¼`Expr`ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€`Symbol`ã«ãªã£ã¦ã„ã‚‹ã€‚

Juliaã¯JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãªã®ã§ã€é–¢æ•°ã®åˆå›å®Ÿè¡Œæ™‚ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
`@generated`ãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦å®šç¾©ã•ã‚ŒãŸé–¢æ•°ã§ã¯ã€ãã®åˆå›å®Ÿè¡Œæ™‚ã«**é–¢æ•°ã‚’ç”Ÿæˆã™ã‚‹**ã‚ˆã†ãªä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒç”Ÿæˆé–¢æ•°(generated function)ã¨å‘¼ã°ã‚Œã¦ã„ã‚‹ç†ç”±ã§ã™ã€‚

é–¢æ•°`g`ã«`println`ã‚’ä»˜ã‘åŠ ãˆã¦ã€åˆå›å®Ÿè¡Œæ™‚ã®ã¿ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```julia
julia> @generated function g_print(x::Real)
           println("å‹$(x)ã§ã®åˆå›å®Ÿè¡Œï¼")
           if x <: Integer
               return :(x+1)
           else
               return :(x+2)
           end
       end
g_print (generic function with 1 method)

julia> g_print(1)
å‹Int64ã§ã®åˆå›å®Ÿè¡Œï¼
2

julia> g_print(1)
2

julia> g_print(1)
2

julia> g_print(1.0)
å‹Float64ã§ã®åˆå›å®Ÿè¡Œï¼
3.0

julia> g_print(1.0)
3.0
```
ã¡ã‚ƒã‚“ã¨åˆå›å®Ÿè¡Œæ™‚ã®ã¿ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã­ï¼

# ã‚‚ã†å°‘ã—è¤‡é›‘ãªä¾‹
## å®šç¾©
å‹ã®å¼•æ•°ã«ã‚ˆã£ã¦æŒ™å‹•ã‚’å¤‰ãˆãŸã„ãªã‚‰ã€æ™®é€šã«å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’ä½¿ãˆã°æ¸ˆã‚€è©±ã§ã™ã€‚æœ€åˆã®ä¾‹ã¯ç°¡å˜ã™ãã¾ã—ãŸã€‚
ã‚‚ã†å°‘ã—è¤‡é›‘ãªä¾‹ã‚’æŒ™ã’ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```julia
julia> using LinearAlgebra, BenchmarkTools

julia> function dot123(s::NTuple{N,Int}) where N
           v = 1:N
           return dot(s,v)
       end
dot123 (generic function with 1 method)

julia> @generated function dot123_gen(s::NTuple{N,Int}) where N
           term(i) = :(s[$i]*$i)
           ex = Expr(:call, :+, [term(i) for i in 1:N]...)
           return ex
       end
dot123_gen (generic function with 1 method)
```
ã“ã‚Œã¯ä¸ãˆã‚‰ã‚ŒãŸ`N`é …ã®`Int`ã®ã‚¿ãƒ—ãƒ«ã‚’ãƒ™ã‚¯ãƒˆãƒ«ã ã¨æ€ã£ã¦ã€åˆ¥ã®ãƒ™ã‚¯ãƒˆãƒ«`1:N`ã¨å†…ç©ã‚’å–ã‚‹ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

`dot123`ã¯LinearAlgebra.jlã‚’ä½¿ã£ã¦`dot`ã§å†…ç©ã‚’è¨ˆç®—ã™ã‚‹ã‚‚ã®ã§ã€`dot123_gen`ã¯ç”Ÿæˆé–¢æ•°ã«ã‚ˆã£ã¦å†…ç©ã‚’è¨ˆç®—ã™ã‚‹ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚
ä¾‹ã¨ã—ã¦$(-1,4,8,2,0,-3)$ã¨ã®å†…ç©

$$\begin{aligned} &(-1,4,8,2,0,-3) \cdot (1,2,3,4,5,6) \\ ={}&-1\times 1 +4\times 2 +8\times 3 +2\times 4 +0\times 5 +-3\times 6 \\ ={}&21\end{aligned}$$

ã‚’è¨ˆç®—ã—ã¦ã¿ã¾ã™ã€‚
```julia
julia> dot123((-1,4,8,2,0,-3))
21

julia> dot123_gen((-1,4,8,2,0,-3))
21
```
ã¡ã‚ƒã‚“ã¨ä¸€è‡´ã—ã¦ã„ã¾ã—ãŸã­ã€‚

## ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```julia
julia> @benchmark dot123((-1,4,8,2,0,-3))
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  1.562 ns â€¦ 8.697 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     1.583 ns             â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.636 ns Â± 0.133 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–ˆ              â–ƒ                                          
  â–†â–ˆâ–†â–‚â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–ˆâ–‚â–‚â–‚â–â–â–â–â–‚â–‚â–‚â–‚â–â–â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚ â–‚
  1.56 ns        Histogram: frequency by time       2.05 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.

julia> @benchmark dot123_gen((-1,4,8,2,0,-3))
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  0.020 ns â€¦ 0.031 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     0.020 ns             â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   0.022 ns Â± 0.004 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–ˆ    â–ƒ                                             â–†      â–
  â–ˆâ–â–â–â–â–ˆâ–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–â–â–â–‡ â–ˆ
  0.02 ns     Histogram: log(frequency) by time    0.031 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
ã‚¤ã‚§ã‚¤ï¼ç”Ÿæˆé–¢æ•°ã®æ–¹ãŒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è‰¯ã„ã§ã™ã­ï¼ï¼
75å€ãã‚‰ã„é€Ÿããªã£ã¦ã„ã¾ã™ã€‚

ã“ã¡ã‚‰ã§ã‚‚`@code_lowered`ãƒã‚¯ãƒ­ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```julia
julia> @code_lowered dot123((-1,4,8,2,0,-3))
CodeInfo(
1 â”€      v = s
â”‚        w = 1:$(Expr(:static_parameter, 1))
â”‚   %3 = Main.dot(v, w)
â””â”€â”€      return %3
)

julia> @code_lowered dot123_gen((-1,4,8,2,0,-3))
CodeInfo(
    @ REPL[3]:1 within `dot123_gen`
   â”Œ @ REPL[3] within `macro expansion`
1 â”€â”‚ %1  = Base.getindex(s, 1)
â”‚  â”‚ %2  = %1 * 1
â”‚  â”‚ %3  = Base.getindex(s, 2)
â”‚  â”‚ %4  = %3 * 2
â”‚  â”‚ %5  = Base.getindex(s, 3)
â”‚  â”‚ %6  = %5 * 3
â”‚  â”‚ %7  = Base.getindex(s, 4)
â”‚  â”‚ %8  = %7 * 4
â”‚  â”‚ %9  = Base.getindex(s, 5)
â”‚  â”‚ %10 = %9 * 5
â”‚  â”‚ %11 = Base.getindex(s, 6)
â”‚  â”‚ %12 = %11 * 6
â”‚  â”‚ %13 = %2 + %4 + %6 + %8 + %10 + %12
â””â”€â”€â”‚       return %13
   â””
)
```
`dot123`ã®æ–¹ã§ã¯å†…ç©ã®è¨ˆç®—ãŒ`dot`ã«ä¸¸æŠ•ã’ã•ã‚Œã¦ã„ã¾ã™ãŒã€`dot123_gen`ã®æ–¹ã§ã¯å†…ç©ã®è¨ˆç®—ãŒã™ã¹ã¦å±•é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦é«˜é€ŸåŒ–ã§ããŸã‚ˆã†ã«æ€ãˆã¾ã™ã€‚

## StaticArrays.jlã‚’ä½¿ã£ãŸå®Ÿè£…
ãã†ã„ãˆã°ã€[StaticArrays.jl](https://zenn.dev/hyrodium/articles/5aa5366062f702)ã¯å›ºå®šé•·é…åˆ—ã‚’æ‰±ã†ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã€å†…éƒ¨çš„ã«ãƒ™ã‚¯ãƒˆãƒ«ã¯ã‚¿ãƒ—ãƒ«ã¨ã—ã¦è¡¨ç¾ã—ã¦ã•ã‚Œã¦ã„ã‚‹ã®ã§ã—ãŸã€‚

ã‚„ã‚„ã“ã—ã„`@generated`ãƒã‚¯ãƒ­ã‚’ä½¿ã‚ãšã¨ã‚‚ã€StaticArrays.jlã§ååˆ†é«˜é€Ÿãªã‚‰å¬‰ã—ã„ã§ã™ã‚ˆã­ã€‚
```julia
julia> using StaticArrays

julia> dot123_sa(s::NTuple{N,Int}) where N = dot(SVector(s), StaticArrays.SUnitRange{1,N}())
dot123_sa (generic function with 1 method)

julia> dot123_sa((-1,4,8,2,0,-3))
21
```
ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼
```julia
julia> @benchmark dot123_sa((-1,4,8,2,0,-3))
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  1.572 ns â€¦ 11.361 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     1.603 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.602 ns Â±  0.125 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                              â–ƒ             â–ˆ                 
  â–‚â–ƒâ–â–â–â–â–â–â–â–â–â–â–â–‚â–â–ˆâ–â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–‚â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–‚â–â–â–â–â–â–â–â–â–â–â–â–„â–‚ â–‚
  1.57 ns        Histogram: frequency by time        1.61 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
ã‚ã‚Œã‚Œã€é€Ÿããªã„ã§ã™ã­â€¦ã€‚ å¿µã®ãŸã‚ä½ãƒ¬ãƒ™ãƒ«è¡¨ç¾ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```julia
julia> @code_lowered dot123_sa((-1,4,8,2,0,-3))
CodeInfo(
1 â”€ %1 = Core.apply_type(Main.SVector, $(Expr(:static_parameter, 1)))
â”‚   %2 = (%1)(s)
â”‚   %3 = StaticArrays.SUnitRange
â”‚   %4 = (%3)(1, $(Expr(:static_parameter, 1)))
â”‚   %5 = Main.dot(%2, %4)
â””â”€â”€      return %5
)
```
`dot123_sa`ã¯`dot123`ã¨åŒæ§˜ã«ã€ä½ãƒ¬ãƒ™ãƒ«è¡¨ç¾ã§ã¯å†…ç©ã®è¨ˆç®—ãŒå±•é–‹ã•ã‚Œã¦ã„ãªã„ã§ã™ã­ã€‚

ã§ã¯ã€LLVMä¸­é–“è¡¨ç¾ã§ã¯ã©ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
```julia
julia> @code_llvm dot123_gen((-1,4,8,2,0,-3))
;  @ REPL[3]:1 within `dot123_gen`
define i64 @julia_dot123_gen_1594([6 x i64]* nocapture nonnull readonly align 8 dereferenceable(48) %0) #0 {
top:
; â”Œ @ REPL[3] within `macro expansion`
; â”‚â”Œ @ tuple.jl:29 within `getindex`
    %1 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 0
; â”‚â””
; â”‚â”Œ @ int.jl:88 within `*`
    %2 = load i64, i64* %1, align 8
(é•·ã„ã®ã§çœç•¥)

julia> @code_llvm dot123_sa((-1,4,8,2,0,-3))
(é•·ã„ã®ã§çœç•¥)
```
å‡ºåŠ›ã•ã‚ŒãŸä¸­é–“è¡¨ç¾ã§ã¯`;`ä»¥ä¸‹ãŒã‚³ãƒ¡ãƒ³ãƒˆãªã®ã§å‰Šé™¤ã§ãã¾ã™ã€‚é©å½“ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’æƒãˆã‚Œã°ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

[ç”Ÿæˆé–¢æ•°`dot123_gen`ã®å‡ºåŠ›]
```llvm
julia> @code_llvm dot123_gen((-1,4,8,2,0,-3))
define i64 @julia_dot123_gen_1594([6 x i64]* nocapture nonnull readonly align 8 dereferenceable(48) %0) #0 {
top:
    %1 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 0
    %2 = load i64, i64* %1, align 8
    %3 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 1
    %4 = load i64, i64* %3, align 8
    %5 = shl i64 %4, 1
    %6 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 2
    %7 = load i64, i64* %6, align 8
    %8 = mul i64 %7, 3
    %9 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 3
    %10 = load i64, i64* %9, align 8
    %11 = shl i64 %10, 2
    %12 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 4
    %13 = load i64, i64* %12, align 8
    %14 = mul i64 %13, 5
    %15 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 5
    %16 = load i64, i64* %15, align 8
    %17 = mul i64 %16, 6
    %18 = add i64 %5, %2
    %19 = add i64 %18, %8
    %20 = add i64 %19, %11
    %21 = add i64 %20, %14
    %22 = add i64 %21, %17
    ret i64 %22
}
```
[StaticArrays.jlã‚’ä½¿ã£ãŸ`dot123_sa`ã®å‡ºåŠ›]
```llvm
julia> @code_llvm dot123_sa((-1,4,8,2,0,-3))
define i64 @julia_dot123_sa_1596([6 x i64]* nocapture nonnull readonly align 8 dereferenceable(48) %0) #0 {
top:
    %1 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 0
    %2 = load i64, i64* %1, align 8
    %3 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 1
    %4 = load i64, i64* %3, align 8
    %5 = shl i64 %4, 1
    %6 = add i64 %5, %2
    %7 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 2
    %8 = load i64, i64* %7, align 8
    %9 = mul i64 %8, 3
    %10 = add i64 %9, %6
    %11 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 3
    %12 = load i64, i64* %11, align 8
    %13 = shl i64 %12, 2
    %14 = add i64 %13, %10
    %15 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 4
    %16 = load i64, i64* %15, align 8
    %17 = mul i64 %16, 5
    %18 = add i64 %17, %14
    %19 = getelementptr inbounds [6 x i64], [6 x i64]* %0, i64 0, i64 5
    %20 = load i64, i64* %19, align 8
    %21 = mul i64 %20, 6
    %22 = add i64 %21, %18
    ret i64 %22
}
```
LLVMä¸­é–“è¡¨ç¾ã®èª­ã¿æ–¹ã«ç­†è€…ã¯è©³ã—ããªã„ã®ã§ã™ãŒã€

* `getelementptr`ã®å‘¨è¾ºã¯ã‚¿ãƒ—ãƒ«ã®è¦ç´ ã‚’å–ã£ã¦ãã‚‹æ“ä½œ
* `mul`, `add`ã¯ã‚¿ãƒ—ãƒ«ã®è¦ç´ ã‚’å–ã£ã¦ãã‚‹æ“ä½œ

ã¨æ€ãˆã°ç‰¹ã«é›£ã—ããªãã€`dot123_gen`ã¨`dot123_sa`ã¯ã©ã¡ã‚‰ã‚‚ã»ã¼åŒã˜LLVMä¸­é–“è¡¨ç¾ã«ãªã£ã¦ã„ã¾ã™ã€‚ä¸¡è€…ã§ç•°ãªã‚‹ã®ã¯**ã‚¿ãƒ—ãƒ«ã®è¦ç´ å–å¾—ã®é †ç•ªã®é•ã„ã®ã¿**ã§ã€å‡¦ç†å†…å®¹ã¯åŒä¸€ã®ã‚ˆã†ã§ã™ã€‚

ã‚ã‚Œã‚Œã‚Œã€ã€LLVMä¸­é–“è¡¨ç¾ãŒ**ã»ã¼åŒã˜**ãªã®ã«å®Ÿè¡Œé€Ÿåº¦ãŒ75å€ç¨‹åº¦ã‚‚ç•°ãªã‚‹ã®ã¯ã‹ãªã‚Šä¸æ€è­°ã§ã™ã­ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å·®ç•°ã¯ã©ã“ã‹ã‚‰æ¥ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ç¢ºè¨¼ã¯ç„¡ã„ã§ã™ãŒã€ä¸Šè¨˜ã®ã€Œã»ã¼åŒã˜ã€ã¨è€ƒãˆã¦ã„ãŸã¨ã“ã‚ã«èª¤ã‚ŠãŒã‚ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¦ã„ã¾ã™ã€‚LLVMä¸­é–“è¡¨ç¾ãŒå‡¦ç†å†…å®¹ã¨ã—ã¦åŒä¸€ã«è¦‹ãˆã¦ã„ã¦ã‚‚ã€CPUä¸Šã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–ã®è¦³ç‚¹ã‹ã‚‰è€ƒãˆã‚Œã°åŒä¸€è¦–ã™ã‚‹ã®ã¯é–“é•ã£ã¦ã„ãŸã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚

ã“ã‚Œã«ã¤ã„ã¦è¡Œã£ãŸå®Ÿé¨“ã‚’æ¬¡ç¯€ã§ã¯ç´¹ä»‹ã—ã¾ã™ã€‚

## ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®å·®ç•°ã«é–¢ã™ã‚‹å®Ÿé¨“
### é€šå¸¸ã®é–¢æ•°ã®å®Ÿè¡Œæ™‚é–“
ç¾çŠ¶ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

* `dot123` 1.6nsç¨‹åº¦
* `dot123_gen` 0.02nsç¨‹åº¦
* `dot123_sa` 1.6nsç¨‹åº¦

`@generated`ãƒã‚¯ãƒ­ã®æ€§è³ªãŒå½±éŸ¿ã—ã¦ã€`dot123_gen`ãŒé€Ÿããªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã¨äºˆæƒ³ã—ã¾ã—ãŸãŒã€æ¬¡ã®å®Ÿè¡Œçµæœã‚’è¦‹ã‚‹é™ã‚Šã¯`@generated`ãƒã‚¯ãƒ­ç„¡ã—ã§ã‚‚è¨ˆæ¸¬çµæœãŒé€Ÿã„ã“ã¨ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ã­ã€‚
```julia
julia> dot123_plain(s::NTuple{6,Int}) = s[1]*1+s[2]*2+s[3]*3+s[4]*4+s[5]*5+s[6]*6
dot123_plain (generic function with 1 method)

julia> dot123_plain((-1,4,8,2,0,-3))
21

julia> @benchmark dot123_plain((-1,4,8,2,0,-3))
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  0.020 ns â€¦ 3.877 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     0.020 ns             â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   0.023 ns Â± 0.039 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–ˆ    â–ƒ                                             â–†    â– â–
  â–ˆâ–â–â–â–â–ˆâ–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–â–â–â–ˆ â–ˆ
  0.02 ns     Histogram: log(frequency) by time    0.031 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```

### ç¹°ã‚Šè¿”ã—ãŸå ´åˆã®å®Ÿè¡Œæ™‚é–“
`dot123_gen`ã¨`dot123_sa`ã«ã¤ã„ã¦1000å›ãšã¤ç¹°ã‚Šè¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```julia
julia> @benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:1000)
BenchmarkTools.Trial: 10000 samples with 646 evaluations.
 Range (min â€¦ max):  190.406 ns â€¦ 586.574 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     194.051 ns               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   195.766 ns Â±  10.211 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–‚â–ˆâ–‡â–‡â–†â–‡â–†â–‚â–‚â–‚â–‚â–‚â–                                                 â–‚
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–ˆâ–†â–‡â–†â–…â–…â–„â–…â–ƒâ–…â–„â–„â–„â–„â–…â–…â–†â–…â–„â–†â–…â–„â–„â–â–ƒâ–„â–ƒâ–ƒâ–â–â–ƒâ–…â–…â–ƒâ–ƒâ–ƒâ–„â–†â–„â–…â–†â–…â–†â–†â–‡â–‡â–ˆ â–ˆ
  190 ns        Histogram: log(frequency) by time        254 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.

julia> @benchmark sum(dot123_sa((-1,4,8,2,0,-i)) for i in 1:1000)
BenchmarkTools.Trial: 10000 samples with 656 evaluations.
 Range (min â€¦ max):  190.421 ns â€¦ 408.410 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     194.316 ns               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   198.860 ns Â±  18.472 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–ˆâ–‚                                                            
  â–†â–ˆâ–ˆâ–„â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚ â–‚
  190 ns           Histogram: frequency by time          303 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
`dot123_gen`ã®æ–¹ãŒé€Ÿã„ã§ã™ãŒã€å¹³å‡å®Ÿè¡Œæ™‚é–“ã¯`195.766 ns`/`198.860 ns`ã®åƒ…ã‹ãªå·®ã§ã—ã‹ãªãã€å½“åˆã‚ˆã†ãª75å€ã®å·®ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

ä¸€å›ã‚ãŸã‚Šã®`dot123_gen`/`dot123_sa`ã®å®Ÿè¡Œæ™‚é–“ã¯å¤§é›‘æŠŠã«å‰²ã‚Šç®—ã—ã¦`0.195 ns`/`0.198 ns`ã«ãªã‚Šã¾ã™ã€‚ä¸€åº¦ã®ã¿ã®å®Ÿè¡Œã§ã¯`0.022 ns`/`1.6 ns`ç¨‹åº¦ã§ã—ãŸã‹ã‚‰ã€`dot123_gen`/`dot123_sa`ã¯ãã‚Œãã‚Œä½é€ŸåŒ–/é«˜é€ŸåŒ–ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚

`dot123_sa`ãŒé«˜é€ŸåŒ–ã•ã‚ŒãŸã®ã¯ã€Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒæ¸›ã£ãŸã€orã€Œè¤‡æ•°å›å‘¼ã³å‡ºã—ã«é–¢ã™ã‚‹æœ€é©åŒ–ãŒè¡Œã‚ã‚ŒãŸã€ã¨äºˆæƒ³ã§ãã¾ã™ã€‚`dot123_gen`ãŒä½é€ŸåŒ–ã•ã‚ŒãŸã®ã¯ã¾ã è¬ã§ã™ã­ã€‚

100å›ãšã¤ç¹°ã‚Šè¿”ã™ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
```julia
julia> @benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:100)
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  1.222 ns â€¦ 13.936 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     1.232 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.261 ns Â±  0.160 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–†â–ˆ â–„                                         â–ƒ â–‚ â–â– â– â–    â–
  â–ˆâ–ˆâ–â–ˆâ–â–„â–â–â–„â–â–„â–â–â–â–ƒâ–ƒâ–â–„â–â–„â–â–„â–â–â–„â–â–ƒâ–â–ƒâ–„â–â–â–â–„â–â–ƒâ–…â–â–…â–â–„â–â–…â–ˆâ–â–ˆâ–â–ˆâ–â–ˆâ–ˆâ–â–ˆâ–â–ˆâ–â–ˆâ–‡ â–ˆ
  1.22 ns      Histogram: log(frequency) by time     1.55 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.

julia> @benchmark sum(dot123_sa((-1,4,8,2,0,-i)) for i in 1:100)
BenchmarkTools.Trial: 10000 samples with 997 evaluations.
 Range (min â€¦ max):  19.595 ns â€¦ 76.523 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     20.430 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   21.026 ns Â±  1.725 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–ƒâ–ƒâ–‚ â–ˆâ–ˆâ–†â–†â–ƒ       â– â–†â–†                            â–‚    â–     â–‚
  â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–„â–„â–„â–‚â–„â–„â–ˆâ–ˆâ–ˆâ–ˆâ–†â–…â–„â–„â–„â–„â–…â–†â–„â–…â–…â–…â–†â–„â–†â–…â–…â–…â–…â–…â–…â–„â–…â–„â–‚â–„â–†â–„â–ˆâ–„â–ƒâ–†â–‡â–ˆâ–„â–…â–…â–‡ â–ˆ
  19.6 ns      Histogram: log(frequency) by time      26.8 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
æ˜ã‚‰ã‹ã«`dot123_gen`ã®æ–¹ãŒ`dot123_sa`ã‚ˆã‚Šã‚‚é€Ÿã„ã§ã™ã­ï¼(17å€ç¨‹åº¦)

`dot123_gen`ã‚’ä½¿ã£ãŸ100å›è¨ˆç®—ã®å¹³å‡å®Ÿè¡Œæ™‚é–“ãŒ`1.261 ns`ã ã£ãŸã®ã§ä¸€å›ã‚ãŸã‚Š`0.012 ns`ã«ãªã‚Šã¾ã™ã€‚å½“åˆã®`0.022 ns`ã«æ¯”ã¹ã¦é«˜é€Ÿã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã¤ã¾ã‚Šã€ç¹°ã‚Šè¿”ã—å›æ•°ãŒå¤šããªã‚‹ã¨`dot123_gen`ã®ä¸€å›ã‚ãŸã‚Šã®å®Ÿè¡Œæ™‚é–“ãŒå¢—åŠ ã™ã‚‹ã‚ˆã†ã§ã™ã€‚

å¹³å‡ã ã‘è¦‹ãŸã„ã®ã§`Statistics.mean`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```julia
julia> mean(@benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:100))
BenchmarkTools.TrialEstimate: 
  time:             1.249 ns
  gctime:           0.000 ns (0.00%)
  memory:           0 bytes
  allocs:           0

julia> mean(@benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:101))
BenchmarkTools.TrialEstimate: 
  time:             1.234 ns
  gctime:           0.000 ns (0.00%)
  memory:           0 bytes
  allocs:           0

julia> mean(@benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:102))
BenchmarkTools.TrialEstimate: 
  time:             1.226 ns
  gctime:           0.000 ns (0.00%)
  memory:           0 bytes
  allocs:           0

julia> mean(@benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:103))
BenchmarkTools.TrialEstimate: 
  time:             53.039 ns
  gctime:           0.000 ns (0.00%)
  memory:           0 bytes
  allocs:           0

julia> mean(@benchmark sum(dot123_gen((-1,4,8,2,0,-i)) for i in 1:104))
BenchmarkTools.TrialEstimate: 
  time:             52.949 ns
  gctime:           0.000 ns (0.00%)
  memory:           0 bytes
  allocs:           0
```
ç¹°ã‚Šè¿”ã—å›æ•°ãŒ102å›ã‚’è¶…ãˆãŸã¨ã“ã‚ã‹ã‚‰æ€¥æ¿€ã«å®Ÿè¡Œæ™‚é–“ãŒå¢—ãˆã¾ã—ãŸã€‚

>ã¾ã ç¢ºè¨¼ã¯ç„¡ã„ã§ã™ãŒã€ä¸Šè¨˜ã®ã€Œã»ã¼åŒã˜ã€ã¨è€ƒãˆã¦ã„ãŸã¨ã“ã‚ã«èª¤ã‚ŠãŒã‚ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¦ã„ã¾ã™ã€‚LLVMä¸­é–“è¡¨ç¾ãŒå‡¦ç†å†…å®¹ã¨ã—ã¦åŒä¸€ã«è¦‹ãˆã¦ã„ã¦ã‚‚ã€CPUä¸Šã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–ã®è¦³ç‚¹ã‹ã‚‰è€ƒãˆã‚Œã°åŒä¸€è¦–ã™ã‚‹ã®ã¯é–“é•ã£ã¦ã„ãŸã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚

å‰ç¯€ã§ä¸Šè¨˜ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ãŸã®ã¯ã“ã®å®Ÿè¡Œçµæœã‚’è¸ã¾ãˆãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

å‡¦ç†ã®ã‚µã‚¤ã‚ºãŒå¢—ãˆã¦ä¸é€£ç¶š^[ç¹°ã‚Šè¿”ã—å›æ•°ã¯æ•´æ•°ãªã®ã§ãã‚‚ãã‚‚é€šå¸¸ã®é€£ç¶šé–¢æ•°ã¨ã—ã¦è€ƒãˆã‚‰ã‚Œãªã„ã§ã™ãŒã€æ„å‘³ã¯ä¼ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚]ã«å®Ÿè¡Œæ™‚é–“ãŒå¤‰ã‚ã‚‹ã€ã¨ã„ã†ã®ã¯CPUã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ãˆã‚‹ã‹å¦ã‹ã«æã‚‰ãé–¢é€£ã—ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚
~~LLVMä¸­é–“è¡¨ç¾ãŒåŒå€¤ã«è¦‹ãˆã¦ã‚‚ã€å‡¦ç†ã®é †ç•ªã«ã‚ˆã£ã¦ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¼‰ã›ã‚„ã™ã„ã‹ã©ã†ã‹ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã€ã“ã‚ŒãŒ`dot123_gen`ã¨`dot123_sa`ã®å®Ÿè¡Œæ™‚é–“ã®å·®ã«ãªã£ãŸã®ã ã¨æ€ã„ã¾ã™ã€‚^[ä»–ã®CPUç’°å¢ƒã§è©¦ã—ãŸå ´åˆã«ã¯æœ¬è¨˜äº‹ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¨ã¯ç•°ãªã‚‹ã‚‚ã®ãŒå¾—ã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚]~~

~~çµè«–ã¨ã—ã¦ã€`@generated`ãƒã‚¯ãƒ­ã‚’ä½¿ã£ãŸç”Ÿæˆé–¢æ•°`dot123_gen`ã®æ–¹ãŒ`StaticArrays.SVector`ã‚’ä½¿ã£ãŸé–¢æ•°`dot123_sa`ã«æ¯”ã¹ã¦é«˜é€Ÿã«ãªã£ã¦ã„ã¾ã—ãŸã€‚ãŸã ã€`@generated`ãƒã‚¯ãƒ­ã‚’ä½¿ã‚ãšã«æ¸ˆã‚€æ–¹ãŒå¬‰ã—ãã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCPUã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¾ã§ã¯ã‚ã¾ã‚Šè€ƒãˆãŸããªã„ã¨ã‚‚æ€ã„ã¾ã™ã€‚å°†æ¥çš„ã«ã¯Juliaæœ¬ä½“ãŒã‚ˆã‚Šå¼·åŠ›ãªæœ€é©åŒ–ã‚’è¡Œã†ã‚ˆã†ã«ãªã£ã¦`dot123_gen`ã¨`dot123_sa`ãŒåŒç­‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‡ºã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã­ã€‚~~

### 1è¦ç´ ã‚¿ãƒ—ãƒ«ã®å ´åˆ
**(2021/12/20æ›´æ–°)**
è©¦ã—ã«1è¦ç´ ã‚¿ãƒ—ãƒ«`(2,)`ã‚’å…¥ã‚Œã¦ã¿ãŸã¨ã“ã‚ã€`dot123_gen`ã¨`dot123_sa`ã¨ã§å®Œå…¨ã«åŒä¸€ã®LLVMä¸­é–“è¡¨ç¾ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚
```julia
julia> @code_llvm dot123_gen((2,))
;  @ REPL[6]:1 within `dot123_gen`
define i64 @julia_dot123_gen_735([1 x i64]* nocapture nonnull readonly align 8 dereferenceable(8) %0) #0 {
top:
; â”Œ @ REPL[6] within `macro expansion`
; â”‚â”Œ @ tuple.jl:29 within `getindex`
    %1 = getelementptr inbounds [1 x i64], [1 x i64]* %0, i64 0, i64 0
; â”‚â””
; â”‚â”Œ @ int.jl:88 within `*`
    %2 = load i64, i64* %1, align 8
; â”‚â””
   ret i64 %2
; â””
}

julia> @code_llvm dot123_sa((2,))
;  @ REPL[2]:1 within `dot123_sa`
define i64 @julia_dot123_sa_737([1 x i64]* nocapture nonnull readonly align 8 dereferenceable(8) %0) #0 {
top:
  %1 = getelementptr inbounds [1 x i64], [1 x i64]* %0, i64 0, i64 0
  %2 = load i64, i64* %1, align 8
  ret i64 %2
}
```
ã—ã‹ã—ã€ä¾ç„¶ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«é€Ÿåº¦ã®å·®ã¯ã‚ã‚Šã¾ã—ãŸã€‚
```julia
julia> @benchmark dot123_gen((2,))
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  0.020 ns â€¦ 0.031 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     0.020 ns             â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   0.022 ns Â± 0.004 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

  â–ˆ    â–ƒ                                             â–†      â–
  â–ˆâ–â–â–â–â–ˆâ–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–â–â–â–ˆ â–ˆ
  0.02 ns     Histogram: log(frequency) by time    0.031 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.

julia> @benchmark dot123_sa((2,))
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  1.202 ns â€¦ 7.755 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     1.222 ns             â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   1.223 ns Â± 0.080 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                                      â–ˆ                      
  â–‚â–‚â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–…â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–ˆâ–â–ˆâ–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–‚â–‚ â–‚
  1.2 ns         Histogram: frequency by time       1.23 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
ã€Œç¹°ã‚Šè¿”ã—å›æ•°ã®å°‘ãªã„å ´åˆã«`dot123_gen`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã‚‹ã€ã¨ã„ã†ã®ã¯å¤šåˆ†æ­£ã—ã„ã¨æ€ã„ãŸã„ã§ã™ãŒã€å®Œå…¨ã«ã‚ˆãåˆ†ã‹ã‚‰ãªããªã£ã¦ãã¾ã—ãŸã€‚

*è©³ã—ã„æ–¹ãŒã„ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ã„ãŸã ããŸã„ã§ã™â€¦ï¼*

# ç”Ÿæˆé–¢æ•°ã®ä½¿ã„ã©ã
## ç„¡é™å€‹ã®å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ
`dot123_gen`ã«ãŠã„ã¦ã¯`NTuple{N,Int}`ã®ãã‚Œãã‚Œã®`N`ã«å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãŒå®šç¾©ã§ãã¾ã—ãŸã€‚
å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®`N`ã¯æ•´æ•°ã§ã€å¯ç®—ç„¡é™å€‹ã®å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãŒå®šç¾©ã§ããŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚^[ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ä¸Šã§æ‰±ã†æ•´æ•°ãªã®ã§å³å¯†ã«ã¯å˜˜ã§ã™ã€‚]

ä»–ã®æ•´æ•°ã‚’ä½¿ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯å‹ã«ã¯`Array{Float64, N}`, `SVector{N,Float64}`ãªã©ãŒã‚ã‚Šã€ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`N`ã«å¿œã˜ã¦é–¢æ•°ã‚’å®šç¾©ã—ãŸã„ã¨ãã«ã‚‚ç”Ÿæˆé–¢æ•°ãŒä¾¿åˆ©ã§ã™ã€‚

ç”Ÿæˆé–¢æ•°ã‚’ä½¿ã†ã‹ã®åˆ¤æ–­ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è€ƒãˆã‚Œã°OKã§ã™ã€‚

* æ™®é€šã®å‹ã®åˆ†å²ã§ã‚ã‚Œã°ã€æœ€åˆã®ä¾‹(`f`, `g`, `h`)ã§ã®`f`ã®ã‚ˆã†ã«å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’ä½¿ãˆã°OK
    * ãƒ¡ã‚½ãƒƒãƒ‰ã®æ•°ãŒé«˜ã€…æœ‰é™å€‹ã§ã‚ã£ã¦ã‚‚ã€å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’ä½¿ãˆã°è‰¯ã„ã€‚
    * æœ‰é™å€‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’å®šç¾©ã™ã‚‹éš›ã«ã¯`@eval`ãƒã‚¯ãƒ­ã‚’ä½¿ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
        ```julia
        julia> for N in 1:10
                   term(i) = :(s[$i]*$i)
                   ex = Expr(:call, :+, [term(i) for i in 1:N]...)
                   @eval function dot123_eval(s::NTuple{$N,Int})
                       $ex
                   end
               end

        julia> dot123_eval((-1,4,8,2,0,-3))
        21

        julia> dot123_eval
        dot123_eval (generic function with 10 methods)
        ```
* ç„¡é™å€‹ã®ãƒ¡ã‚½ãƒƒãƒ‰^[å³å¯†ã«ã¯ç”Ÿæˆé–¢æ•°ã§ä½œã‚‰ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¯1ã¤ã ã‘ã§ã™ã€‚å‹ã«å¿œã˜ã¦é¸ã°ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ãŒç„¡é™å€‹ã‚ã‚‹ã€ã¨ã„ã†æ„å‘³ã§ç„¡é™å€‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚]ãŒå¿…è¦ã«ãªã‚Œã°ã€è‡ªå‰ã§å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’å®šç¾©ã§ããªã„ã€‚
    * ã“ã“ã§ç”Ÿæˆé–¢æ•°ãŒä¾¿åˆ©ï¼

## ~~å®Ÿè¡Œåˆå›ã®ã¿ã«ä½•ã‚‰ã‹ã®å‡¦ç†ã‚’ã—ãŸã„å ´åˆ~~
~~ç”Ÿæˆé–¢æ•°ã‚’ä½¿ãˆã°ã€`g_print`ã®ä¾‹ã§è¦‹ãŸã‚ˆã†ã«ã€åˆå›ã®ã¿å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å…·ä½“çš„ãªç”¨é€”ã¯æ€ã„ã¤ã‹ãªã„ã§ã™ãŒã€ä¾¿åˆ©ãªã“ã¨ãŒã‚ã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚~~

ã“ã®è¨˜è¿°ã«é–¢ã—ã¦èª¤ã‚ŠãŒã‚ã‚Šã¾ã—ãŸã€‚è©³ç´°ã¯antimon2ã•ã‚“ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ï¼


# å‚è€ƒæ–‡çŒ®
* [Understanding generated functions](https://discourse.julialang.org/t/understanding-generated-functions/10092/2)
  * Julia Discourceã§ã®ç”Ÿæˆé–¢æ•°ã«ã¤ã„ã¦ã®è³ªå•ã€‚
  * å›ç­”ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã€‚
* [Metaprogramming](https://docs.julialang.org/en/v1/manual/metaprogramming/)
  * Juliaã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
  * ç”Ÿæˆé–¢æ•°ã ã‘ã§ãªãã€ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å…¨èˆ¬ã«ã¤ã„ã¦è¨˜è¼‰ãŒã‚ã‚‹ã€‚
