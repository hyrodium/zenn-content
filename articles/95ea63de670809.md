---
title: "`@test_broken ..`ã‚ˆã‚Šã‚‚`@test .. broken=..`ã®æ–¹ãŒè‰¯ã‹ã£ãŸ"
emoji: "ğŸ’”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "julia"
  - "ãƒ†ã‚¹ãƒˆ"
published: true
published_at: 2023-12-05
---

ã“ã‚Œã¯[Julia Advent Calendar 2023](https://qiita.com/advent-calendar/2023/julia)ã®5æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

# TL;DR

```julia
@test_broken hogehoge
```

ã‚ˆã‚Šã‚‚

```julia
@test hogehoge broken=true
```

ã®æ–¹ãŒå¹¸ã›ã«ãªã‚Œã‚‹ã‹ã‚‚çŸ¥ã‚Œãªã„ã€‚

# Juliaã®ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã®å¾©ç¿’

Juliaã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã¾ã™ã€‚

* `@test ex`ã§`ex`ãŒ`true`ã§ã‚ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹
* `@testset`ã§ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘

```julia
@testset "arithmetic operations" begin
    @test 1 + 1 == 2
    @test 3 / 2 == 1.5
    @test 3 Ã· 2 == 1
    @test isnan(0/0)
end
```

* ã‚¨ãƒ©ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯`@test_throws`ã‚’ä½¿ã†
* æœ€åˆã®å¼•æ•°ã¯ã‚¨ãƒ©ãƒ¼ã®å‹ã€‚

```julia
@testset "sqrt operations" begin
    @test_throws DomainError sqrt(-1)  # è¤‡ç´ æ•°ãŒæ¬²ã—ã‘ã‚Œã° `sqrt(-1+0im)`ã¨æ›¸ã‘ã°è‰¯ã„
end
```

* å®Ÿè£…ä¸å‚™ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯`@test_broken`ã‚’ä½¿ã†
* `@test_broken`ãŒæˆåŠŸ(`true`)ãªã‚‰ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹

```julia
my_sinc(x) = sin(x)/x
@test_broken my_sinc(0) == 1
```

ä»¥ä¸Šã®ä¾‹ã‚’åˆã‚ã›ã¦REPLã§å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/0a1fab3b6736-20231204.png)

ãƒ†ã‚¹ãƒˆçµæœã®è¦ç´„ã¨å®Ÿè¡Œæ™‚é–“ã®å‡ºåŠ›ãŒè¦‹ã‚„ã™ã„ã§ã™ã­ã€‚

# ã‚±ãƒ¼ã‚¹â‘ 
## å•é¡Œ
`Base.one`ã‚’è‡ªåˆ†ã§å®Ÿè£…ã—ãŸ`my_one`é–¢æ•°ã‚’ä½œã£ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ãŸã ã—ã€ã‚ã–ã¨é–“é•ãˆãŸå®šç¾©ã§ã€‚

```julia
my_one(::Type{Float64}) = 1.0
my_one(::Type{Float32}) = 1.0  # `1f0`ãŒæ­£ã—ã„å®šç¾©
@testset "sometimes broken" begin
    @testset for T in (Float64, Float32)  # `@testset`ã¯`for`ã«ã‚‚ä½¿ãˆã‚‹ï¼
        @test my_one(T) == 1
        @test_broken my_one(T) isa T  # `T`ãŒ`Float32`ã®ã¨ãã ã‘broken
    end
end
```

![](https://storage.googleapis.com/zenn-user-upload/a65c371b9a31-20231204.png)

`@test_broken`ãŒ`T==Float64`ã®ã¨ãã«brokenã˜ã‚ƒãªã„ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã­ã€‚

çŠ¶æ³æ•´ç†:

* `for`æ–‡ã®ä¸­ã®`@test_broken`ãªã®ã§ã€`true`ã¨`false`ä¸¡æ–¹ã®ã‚±ãƒ¼ã‚¹ã‚’æ‰±ã†å¿…è¦ãŒã‚ã‚‹
* ã¤ã¾ã‚Šã€`T===Float32`ã®ã¨ãã ã‘`@test_broken`ã§ã€`T===Float64`ã®ã¨ãã¯é€šå¸¸ã®`@test`ã‚’ä½¿ã„ãŸã„

## è§£æ±ºç­–
ãã“ã§`@test hogehoge broken=..`ã§ã™ã‚ˆï¼
ã“ã‚Œã«ã‚ˆã£ã¦`broken`ãŒ`true`ã®ã¨ãã¯`@test`ãŒ`@test_broken`ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```julia
my_one(::Type{Float64}) = 1.0
my_one(::Type{Float32}) = 1.0
@testset "sometimes broken" begin
    @testset for T in (Float64, Float32)
        @test my_one(T) == 1
        @test my_one(T) isa T broken=(T===Float32)  # `T`ãŒ`Float32`ã®ã¨ãã ã‘broken
    end
end
```

![](https://storage.googleapis.com/zenn-user-upload/bc2cbc0b815d-20231204.png)

ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã›ã‚“ã§ã—ãŸã€‚
brokenã¨ã—ã¦æ‰±ã†ã‚±ãƒ¼ã‚¹ã‚’`true`/`false`ã§æŒ‡å®šã§ãã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã­ã€‚

# ã‚±ãƒ¼ã‚¹â‘¡
## å•é¡Œ
è‡ªåˆ†ã§å®Ÿè£…ã—ãŸ`my_sin`é–¢æ•°ã®æ•°å€¤ç²¾åº¦ã‚’ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```julia
my_sin(x) = x-x^3/6+x^5/120  # ãƒ†ã‚¤ãƒ©ãƒ¼å±•é–‹ã®æ‰“ã¡åˆ‡ã‚Š
@testset "sometimes broken" begin
    for x in range(-1,1,length=100)
        @test_broken abs(my_sin(x) - sin(x)) < 0.0001  # 10/100 ã®ã‚±ãƒ¼ã‚¹ã§broken
    end
end
```

![](https://storage.googleapis.com/zenn-user-upload/870c6e30e22e-20231204.png)
(é•·ã„ã‚¨ãƒ©ãƒ¼ä¸­ç•¥)
![](https://storage.googleapis.com/zenn-user-upload/039f28b6560d-20231204.png)

åŸç‚¹ã‹ã‚‰é›¢ã‚Œã‚‹ã»ã©ç²¾åº¦ãŒè½ã¡ã‚‹ã®ã§ã€ãã®å½±éŸ¿ã§å·¦å³5ç‚¹ãšã¤ãƒ†ã‚¹ãƒˆã«é€šã‚‰ãªã‹ã£ãŸã‚ˆã†ã§ã™ã­ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f6ed792ab973-20231204.png)

## è§£æ±ºç­–
ã“ã“ã§ã‚‚`@test hogehoge broken=..`ã§ã™ã‚ˆï¼

```julia
my_sin(x) = x-x^3/6+x^5/120  # ãƒ†ã‚¤ãƒ©ãƒ¼å±•é–‹ã®æ‰“ã¡åˆ‡ã‚Š
@testset "sometimes broken" begin
    for x in range(-1,1,length=100)
        # ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚’æ˜ç¤ºã§ããªã„ã®ã§`broken`ã«ãƒ†ã‚¹ãƒˆå†…å®¹ã‚’ç›´æ¥è¨˜è¼‰ã™ã‚Œã°OK
        @test abs(my_sin(x) - sin(x)) < 0.0001 broken=!(abs(my_sin(x) - sin(x)) < 0.0001)
    end
end
```

![](https://storage.googleapis.com/zenn-user-upload/a1b5ffff277e-20231204.png)

ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆã¾ã—ãŸã­ã€‚ã‚„ã£ãŸãœ

# ã¾ã¨ã‚ & è£œè¶³

* `@test`ãƒã‚¯ãƒ­ã¯`broken`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ãŒä¾¿åˆ©ã€‚
  * `for`ã®ä¸­ã§éƒ¨åˆ†çš„ã«`broken`ã«ãªã‚‹å ´åˆã«ç‰¹ã«ä¾¿åˆ©ã€‚
  * ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã¯ Julia v1.7 ä»¥ä¸Šã§ã—ã‹ä½¿ãˆãªã„ã“ã¨ã«æ³¨æ„ã€‚
* [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.julialang.org/en/v1.9/stdlib/Test/#Test.@test)ã§ååˆ†ã˜ã‚ƒãªã‹ã£ãŸã‚“ã§ã™ã‹?
  * å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯`@test 2 + 2 â‰ˆ 5 atol=1 broken=false`ã‚„`@test 2 + 2 â‰ˆ 6 atol=1 broken=true`ã¿ãŸã„ãªè‡ªæ˜ãªä¾‹ã—ã‹ç„¡ãã€`broken`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã®æœ¬å½“ã®æœ‰ã‚Šé›£ã¿ãŒä¼ã‚ã‚Šã«ãã„æ°—ãŒã—ã¾ã—ãŸã€‚
  * ãªã®ã§ã“ã®è¨˜äº‹ãŒå­˜åœ¨ã—ã¾ã™ã€‚
