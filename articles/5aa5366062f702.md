---
title: "å›ºå®šé•·é…åˆ—ã®ãŸã‚ã®StaticArrays.jl"
emoji: "ğŸ—ƒï¸"
type: "tech"
topics:
  - "julia"
  - "é«˜é€ŸåŒ–"
  - "é…åˆ—"
published: true
published_at: "2021-12-13 03:21"
---

ã“ã‚Œã¯[Julia Advent Calendar 2021](https://qiita.com/advent-calendar/2021/julia)ã®13æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

# TL;DR
* å›ºå®šé•·é…åˆ—ã®ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸[`StaticArrays.jl`](https://github.com/JuliaArrays/StaticArrays.jl)ãŒä¾¿åˆ©ï¼
  * 3æ¬¡å…ƒç©ºé–“ã®æ¼”ç®—ãªã©ã€é…åˆ—ã®é•·ã•ãŒæ±ºã¾ã£ã¦ã„ã‚‹çŠ¶æ³ã¯è‰²ã€…ã‚ã‚Šã¾ã™ã€‚
  * ãã®ã‚ˆã†ãªå ´åˆã«é«˜é€ŸåŒ–ãŒã§ãã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™
  * æ¥µç«¯ãªã‚±ãƒ¼ã‚¹ã§ã¯é€šå¸¸ã®é…åˆ—ã«æ¯”ã¹ã¦10å€ä»¥ä¸Šé€Ÿããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
* `StaticArrays`ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹å‹ã¯`SArray`ã§ã™ãŒã€ãã‚Œä»¥å¤–ã«ã‚‚`MArray`ã‚„`SizedArray`ãªã©ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ã„åˆ†ã‘ã‚Œã°OK
  * çŸ­ã„å›ºå®šé•·ã§immutableãªå ´åˆ â†’ `SArray`
  * çŸ­ã„å›ºå®šé•·ã§mutableãªå ´åˆ â†’ `MArray`
  * é•·ã„å›ºå®šé•·ã®å ´åˆ â†’ `Array`

# å®Ÿè¡Œç’°å¢ƒ

å®Ÿè¡Œç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
```julia
julia> versioninfo()
Julia Version 1.7.0
Commit 3bf9d17731 (2021-11-30 12:12 UTC)
Platform Info:
  OS: Linux (x86_64-pc-linux-gnu)
  CPU: AMD Ryzen 7 2700X Eight-Core Processor
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-12.0.1 (ORCJIT, znver1)
Environment:
  JULIA_EDITOR = code
  JULIA_NUM_THREADS = 

(@v1.7) pkg> status StaticArrays
      Status `~/.julia/environments/v1.7/Project.toml`
  [90137ffa] StaticArrays v1.2.13
```

# é«˜é€ŸåŒ–ã®ä¾‹
è¡Œåˆ—ã¨ãƒ™ã‚¯ãƒˆãƒ«ã®ç©ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```julia
using StaticArrays  # æœ¬è¨˜äº‹ã®ä¸»å½¹
using BenchmarkTools  # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

# æ™®é€šã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—
M0 = randn(3,3)
v0 = randn(3)
@benchmark M0*v0

# StaticArrays.jlã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—
v1 = @SVector randn(3)
M1 = @SMatrix randn(3,3)
@benchmark M1*v1
```

`v0, M0`ãŒé€šå¸¸ã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—ã§ã€`v1, M1`ãŒStaticArrays.jlã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8c432ed7c4fc-20211212.png)

ä¸Šç”»åƒã¯ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®çµæœã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã€StaticArrays.jlã‚’ä½¿ã£ãŸæ–¹ãŒ3.8å€ç¨‹åº¦é«˜é€Ÿã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚‚æ¸›ã£ã¦ã„ã¾ã™ã­ã€‚(80 bytes -> 32 bytes)

# StaticArrays.jlã§å®šç¾©ã•ã‚Œã‚‹å‹
`using StaticArrays`ã™ã‚Œã°ã€æŠ½è±¡å‹`StaticArray`ã¨ãã®éƒ¨åˆ†å‹(å…·è±¡å‹)ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```julia
julia> subtypes(StaticArray)  # StaticArrayã®éƒ¨åˆ†å‹ã‚’èª¿ã¹ã‚‹
6-element Vector{Any}:
 FieldArray{N} where N<:Tuple
 MArray
 SArray
 SHermitianCompact
 SizedArray
 StaticArrays.SUnitRange
```
ã“ã‚Œã‚‰ã®å‹ã¯è¦ç´„ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚^[ã“ã®ä»–ã«ã‚‚`Scalar`, `SOneTo`, `TrivialView`ãªã©ãŒStaticArrays.jlã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã¾ã™ãŒã€ã“ã‚Œã‚‰ã¯`subtypes(StaticArray)`ã§ç¢ºèªã§ãã¾ã›ã‚“ã€‚æœ¬è¨˜äº‹ã§ã¯`Array`/`SArray`/`MArray`/`SizedArray`ã®æ¯”è¼ƒã‚’ä¸»ã«æ‰±ã„ãŸã„ã®ã§ã€æ·±ãç«‹ã¡å…¥ã‚‰ãªã„ã“ã¨ã«ã—ã¾ã™ã€‚]

* `SArray` immutableãªå›ºå®šé•·é…åˆ—
  * è¦ç´ ã¸ã®ä»£å…¥ã‚’ã—ãªã„å ´åˆã¯ã“ã‚Œã‚’ä½¿ãˆã°OKã€‚
* `MArray` mutableãªå›ºå®šé•·é…åˆ—
  * è¦ç´ ã¸ã®ä»£å…¥ã‚’ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã€‚ãŸã ã—`SArray`ã‚ˆã‚Šé…ã„ã€‚
* `SizedArray` mutableãªå›ºå®šé•·é…åˆ—
  * ä½¿ã„æ–¹ã¯`MArray`ã«ã»ã¼åŒã˜ã€å†…éƒ¨å®Ÿè£…ãŒç•°ãªã‚‹ã€‚
  * å¤šãã®å ´åˆ`MArray`ã®æ–¹ãŒé€Ÿã„ã€‚
* `FieldArray`
  * structã§å®šç¾©ã—ãŸå›ºå®šé•·é…åˆ—ã«ä¾¿åˆ©
  * (æœ¬è¨˜äº‹ã§ã¯è©³ç´°ã‚’æ‰±ã„ã¾ã›ã‚“ã€‚)
* `SHermitanCompact`
  * å›ºå®šé•·ã®Hermiteè¡Œåˆ—ã‚’æ‰±ã†ãŸã‚ã®å‹
  * å¯¾ç§°è¡Œåˆ—ã®ãŸã‚ã®å‹`SSymetric`ã¯ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
  * (æœ¬è¨˜äº‹ã§ã¯è©³ç´°ã‚’æ‰±ã„ã¾ã›ã‚“ã€‚)
* `SUnitRange`
  * `Base.UnitRange`ã«å¯¾å¿œã™ã‚‹å›ºå®šé•·é…åˆ—ã€‚
  * (æœ¬è¨˜äº‹ã§ã¯è©³ç´°ã‚’æ‰±ã„ã¾ã›ã‚“ã€‚)

`SArray`/`MArray`/`SizedArray`ã¯é€šå¸¸ã®é…åˆ—`Array`ã«åˆ¶ç´„(å›ºå®šé•·ã€ä¸å¯å¤‰(immutable)ãªã©)ãŒåŠ ã‚ã£ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã§ã‚‚ã†å°‘ã—è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

## SArray
ã“ã‚Œã¯statically-sized arrayã®ç•¥ã§ã€å›ºå®šé•·ã®(immutableãª)é…åˆ—ã‚’è¡¨ã—ã¾ã™ã€‚
`Vector{T}`ãŒ`Array{T,1}`ã®aliasã«ãªã£ã¦ã„ã‚‹ã®ã¨åŒæ§˜ã«ã€`SMatrix{S1, S2, T, L}`ãŒ`SArray{Tuple{S1, S2}, T, 2, L}`ã®aliasã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã¯ã“ã®`SMatrix`ã‚’ä¾‹ã«ã—ã¦ã¿ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```julia
L1 = @SMatrix [1 2 3;4 5 6]  # ãƒã‚¯ãƒ­ã‚’ä½¿ãˆã°é€šå¸¸ã®å®šç¾©ãŒãã®ã¾ã¾ä½¿ãˆã‚‹
L2 = SMatrix{2,3}([1 2 3;4 5 6])  # è¡Œåˆ—(Matrix)ã‹ã‚‰å¤‰æ›ã—ã¦ä½œã‚‹ã“ã¨ã‚‚ã§ãã‚‹ãŒã€ä¸€åº¦Matrixã‚’ä½œã£ã¦ã‹ã‚‰å¤‰æ›ã™ã‚‹ãŸã‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯è‰¯ããªã„
L3 = SMatrix{2,3}(1,4,2,5,3,6)  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¶­æŒã—ã¦ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä½œã‚‹éš›ã«ã¯é †ç•ªã«æ°—ã‚’ã¤ã‘ã‚‹(comumn-majorãªã®ã§)
L1 === L2 === L3  # true, ã™ã¹ã¦å³å¯†ã«ç­‰ã—ã„
```
`SVector, SArray`ã§ã‚‚åŒæ§˜ã«ã§ãã¾ã™ã€‚

immutableãªã®ã§è¦ç´ ã¸ã®ä»£å…¥ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
```julia
L1 .*= 2  # ã‚¨ãƒ©ãƒ¼
```

å›ºå®šé•·ãªã®ã§è¦ç´ ã®è¿½åŠ ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
```julia
push!(L1,2)  # ã‚¨ãƒ©ãƒ¼
```

## MArray
ã“ã‚Œã¯statically-sized mutable arrayã®ç•¥ã§ã€å›ºå®šé•·ã®mutableãªé…åˆ—ã‚’è¡¨ã—ã¾ã™ã€‚

`SMatrix`ã¨åŒæ§˜ã«ã€ã“ã“ã§ã‚‚`MMatrix`ã‚’ä¾‹ã«ã—ã¦ã¿ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```julia
M1 = @MMatrix [1 2 3;4 5 6]  # ãƒã‚¯ãƒ­ã‚’ä½¿ãˆã°é€šå¸¸ã®å®šç¾©ãŒãã®ã¾ã¾ä½¿ãˆã‚‹
M2 = MMatrix{2,3}([1 2 3;4 5 6])  # è¡Œåˆ—(Matrix)ã‹ã‚‰å¤‰æ›ã—ã¦ä½œã‚‹ã“ã¨ã‚‚ã§ãã‚‹ãŒã€ä¸€åº¦Matrixã‚’ä½œã£ã¦ã‹ã‚‰å¤‰æ›ã™ã‚‹ãŸã‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯è‰¯ããªã„
M3 = MMatrix{2,3}(1,4,2,5,3,6)  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¶­æŒã—ã¦ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä½œã‚‹éš›ã«ã¯é †ç•ªã«æ°—ã‚’ã¤ã‘ã‚‹(comumn-majorãªã®ã§)
M1 === M2 === M3  # false, mutableãªã®ã§å³å¯†ã«ã¯ç­‰ã—ããªã„
M1 == M2 == M3  # true, ç­‰å·ã¯æˆç«‹ã™ã‚‹
```
`MVector, MArray`ã§ã‚‚åŒæ§˜ã«ã§ãã¾ã™ã€‚

mutableãªã®ã§è¦ç´ ã¸ã®ä»£å…¥ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã›ã‚“ã€‚
```julia
M1 .*= 2
```

å›ºå®šé•·ãªã®ã§è¦ç´ ã®è¿½åŠ ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
```julia
push!(M1,2)  # ã‚¨ãƒ©ãƒ¼
```

## SizedArray
ã“ã‚Œã‚‚å›ºå®šé•·ã®é…åˆ—ã§ã™ãŒã€`SArray, MArray`ã¨ã¯ç•°ãªã‚Šã€fieldã¨ã—ã¦é…åˆ—ã‚’ãã®ã¾ã¾æŒã£ã¦ã„ã¾ã™ã€‚ã¨ã‚Šã‚ãˆãšã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œã‚Šæ–¹ã‹ã‚‰è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

`SMatrix`ã¨åŒæ§˜ã«ã€ã“ã“ã§ã‚‚`MMatrix`ã‚’ä¾‹ã«ã—ã¦ã¿ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```julia
N1 = SizedMatrix{2, 3}([1 2 3;4 5 6])  # é€šå¸¸ã®è¡Œåˆ—Matrixã‹ã‚‰å®šç¾©
N2 = SizedMatrix{2, 3}(1,4,2,5,3,6)  # ã‚„ã¯ã‚Šã“ã¡ã‚‰ã®æ–¹ãŒé€Ÿã„ (@benchmarkã§ç¢ºèªã©ã†ã)
N1 === N2  # false, mutableãªã®ã§å³å¯†ã«ã¯ç­‰ã—ããªã„
N1 == N2  # true, ç­‰å·ã¯æˆç«‹ã™ã‚‹
```
`SizedVector, SizedArray`ã§ã‚‚åŒæ§˜ã«ã§ãã¾ã™ã€‚

å‰è¿°ã®ã‚ˆã†ã«ã€SizedArrayã¯fieldã¨ã—ã¦é…åˆ—ã‚’ãã®ã¾ã¾æŒã£ã¦ã„ã¾ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ã«ã¯`dump`é–¢æ•°ãŒä½¿ãˆã¾ã™ã€‚
REPLã§å®Ÿè¡Œã—ãŸçµæœãŒã“ã¡ã‚‰ã§ã™ã€‚
```julia
julia> dump(L1)
SMatrix{2, 3, Int64, 6}
  data: NTuple{6, Int64}
    1: Int64 1
    2: Int64 4
    3: Int64 2
    4: Int64 5
    5: Int64 3
    6: Int64 6

julia> dump(M1)
MMatrix{2, 3, Int64, 6}
  data: NTuple{6, Int64}
    1: Int64 1
    2: Int64 4
    3: Int64 2
    4: Int64 5
    5: Int64 3
    6: Int64 6

julia> dump(N1)
SizedMatrix{2, 3, Int64, 2, Matrix{Int64}}
  data: Array{Int64}((2, 3)) [1 2 3; 4 5 6]
```
`SMatrix`, `MMatrix`ã¨ã‚‚ã«å†…éƒ¨çš„ã«ã¯tupleã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦ã„ã¾ã™ãŒã€`SizedMatrix`ã¯å†…éƒ¨çš„ã«ã¯`Matrix`ã‚’æŒã£ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

`MMatrix`ã¨`SizedMatrix`ã¯å†…éƒ¨å®Ÿè£…ãŒç•°ãªã‚‹ã ã‘ã§ã€å‡ºæ¥ã‚‹ã“ã¨ã¯åŸºæœ¬çš„ã«ã¯åŒã˜ã§ã™ã€‚
ãªã®ã§mutableãªã®ã§è¦ç´ ã¸ã®ä»£å…¥ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã›ã‚“ã—
```julia
N1 .*= 2
```
å›ºå®šé•·ãªã®ã§è¦ç´ ã®è¿½åŠ ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
```julia
push!(N1,2)  # ã‚¨ãƒ©ãƒ¼
```

# ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

## `Array` vs `SArray`
### N = 3
å†’é ­ã®ç¹°ã‚Šè¿”ã—ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã‚Šã¾ã™ã€‚
```julia
N = 3

# æ™®é€šã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—
M0 = randn(N,N)
v0 = randn(N)
result0 = @benchmark M0*v0

# StaticArrays.jlã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—
v1 = @SVector randn(N)
M1 = @SMatrix randn(N,N)
result1 = @benchmark M1*v1

judge(mean(result1),mean(result0))
```
`judge`çµæœã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã™â†“
![](https://storage.googleapis.com/zenn-user-upload/5136904dfa2a-20211213.png)
å†ã³è¨ˆæ¸¬ã—ãŸã®ã§å†’é ­ã¨çµæœãŒç•°ãªã‚Šã¾ã™ãŒã€`-76.40%`ã®é«˜é€ŸåŒ–ã€ã¤ã¾ã‚Š1/4ç¨‹åº¦ã®è¨ˆç®—æ™‚é–“ã«ãªã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

### N = 50
ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ã€‚
```julia
N = 50

# æ™®é€šã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—
M0 = randn(N,N)
v0 = randn(N)
result0 = @benchmark M0*v0

# SArray
v1 = @SVector randn(N)
M1 = @SMatrix randn(N,N)  # JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãªã®ã§æœ€åˆã¯æ™‚é–“ãŒã‹ã‹ã‚‹
result1 = @benchmark M1*v1

judge(mean(result1),mean(result0))
```
![](https://storage.googleapis.com/zenn-user-upload/b0b4e1525a0c-20211213.png)

ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¯æ¸›ã‚Šã¾ã—ãŸãŒã€å®Ÿè¡Œé€Ÿåº¦ã¯é€šå¸¸ã®ãƒ™ã‚¯ãƒˆãƒ«ã«æ¯”ã¹ã¦åƒ…ã‹ã«æ‚ªåŒ–ã—ã¾ã—ãŸã€‚^[StaticArraysã«ã‚ˆã£ã¦é…åˆ—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯å‰Šæ¸›ã§ãã¾ã™ãŒã€é…åˆ—ã®ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®å¯„ä¸ãŒå°ã•ããªã‚‹ã®ã§BLASã§è¨ˆç®—ã™ã‚‹æ–¹ãŒé€Ÿããªã‚Šã¾ã™ã€‚]

## `SArray` vs `MArray`
```julia
N = 3

# SArray
v1 = @SVector randn(N)
M1 = @SMatrix randn(N,N)
result1 = @benchmark M1*v1

# MArray
v2 = @MVector randn(N)
M2 = @MMatrix randn(N,N)
result2 = @benchmark M2*v2

judge(mean(result2),mean(result1))
```
![](https://storage.googleapis.com/zenn-user-upload/ea91c8029223-20211213.png)

åƒ…ã‹ã§ã™ãŒã€`SArray`ã®æ–¹ãŒ`MArray`ã‚ˆã‚Šã‚‚é€Ÿã„ã‚ˆã†ã§ã™ã€‚ä¸€èˆ¬ã«ã€immutableã‚ˆã‚Šã‚‚mutableã®æ–¹ãŒä½é€Ÿãªã®ã§ã€è¦ç´ ã¸ã®å†ä»£å…¥ã‚’é¿ã‘ã‚‰ã‚Œã‚‹å ´åˆã¯`SArray`ã‚’ä½¿ã†ã®ãŒè‰¯ã„ã§ã™ã­ã€‚^[`MArray`ã®æ–¹ãŒé€Ÿã„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœãŒå¾—ã‚‰ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å·®ã¯è»½å¾®ãªã‚ˆã†ã§ã™ã€‚]

## `MArray` vs `SizedArray`
```julia
N = 3

# MArray
v2 = @MVector randn(N)
M2 = @MMatrix randn(N,N)
result2 = @benchmark M2*v2

# SizedArray
v3 = SizedArray(v2)
M3 = SizedArray(M2)
result3 = @benchmark M3*v3

judge(mean(result3),mean(result2))
```
![](https://storage.googleapis.com/zenn-user-upload/c90aca4b4d48-20211213.png)

æ˜ã‚‰ã‹ã«`MArray`ã®æ–¹ãŒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè‰¯ã„ã§ã™ã­ã€‚
ã§ã¯ã€`SizedArray`ã®æ–¹ãŒè‰¯ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‡ºã™ã®ã¯ã©ã®ã‚ˆã†ãªçŠ¶æ³ã§ã—ã‚‡ã†ã‹ï¼Ÿ
```julia
# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆç”¨ã®é–¢æ•°
f2(M) = MMatrix{3,3}(M)
f3(M) = SizedMatrix{3,3}(M)

n = 3
M = randn(n,n)

result2_ = @benchmark f2(M)
result3_ = @benchmark f3(M)

judge(mean(result3_),mean(result2_))
```
![](https://storage.googleapis.com/zenn-user-upload/ed854b74d00c-20211213.png)
ä¸Šè¨˜ã®ä¾‹ã§ã¯`SizedArray`ã®æ–¹ãŒé€Ÿã„çµæœã¨ãªã‚Šã¾ã—ãŸã€‚
`SizedArray`ã¯fieldã¨ã—ã¦`Array`ã‚’ãã®ã¾ã¾æŒã£ã¦ã„ã‚‹ã®ã§ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã®å¤‰æ›ã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‰ãšã€é«˜é€Ÿã«ãªã£ã¦ã„ã¾ã™ã€‚
ãŸã ã—ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆå¾Œã®æ¼”ç®—ãŒçµå±€é…ã„ã®ã§ã€`MArray`ã‚’ä½¿ã†å ´é¢ã®æ–¹ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚

## `SizedArray` vs `Array`
```julia
N = 3

# æ™®é€šã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—
M0 = randn(N,N)
v0 = randn(N)
result0 = @benchmark M0*v0

# SizedArray
v1 = SizedVector{N}(randn(N))
M1 = SizedMatrix{N,N}(randn(N,N))
v3 = SizedArray(v1)
M3 = SizedArray(M1)
result3 = @benchmark M3*v3

judge(mean(result3),mean(result0))
```
![](https://storage.googleapis.com/zenn-user-upload/e9a030fc9f5c-20211213.png)

`StaticArray`ã®ä¸­ã§ã¯ã‹ãªã‚Šé…ã„æ–¹ã ã£ãŸ`SizedArray`ã§ã™ãŒã€é€šå¸¸ã®`Array`ã«æ¯”ã¹ã‚Œã°ååˆ†é«˜é€Ÿã§ã¯ã‚ã‚Šã¾ã™ã€‚

## ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¾ã¨ã‚
è¨ˆç®—æ™‚é–“ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
`SArray` â‰¤ `MArray` â‰ª `SizedArray` â‰ª `Array`

* çŸ­ã„å›ºå®šé•·é…åˆ—ã‹ã¤immutable
  * `SArray`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†
* çŸ­ã„å›ºå®šé•·é…åˆ—ã‹ã¤mutable
  * `MArray`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†
* é•·ã„å›ºå®šé•·é…åˆ—
  * `Array`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†

# ãŠã¾ã‘

## `struct`ã¨ã®æ¯”è¼ƒ
ç¹°ã‚Šè¿”ã™ã‚ˆã†ã§ã™ãŒã€ã€Œãƒ™ã‚¯ãƒˆãƒ«ã®æ¬¡å…ƒãŒæ±ºã¾ã£ã¦ã„ã‚‹ã¨ãã€ã«ã—ã‹StaticArrays.jlã¯ä½¿ãˆã¾ã›ã‚“ã€‚ã“ã“ã§ã¯`struct`ã¨ã®æ¯”è¼ƒã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

2æ¬¡å…ƒä¸Šã®ç‚¹ã‚’ä½¿ã†ã®ã§ã‚ã‚Œã°
```julia
struct Point2D
    x::Float64
    y::Float64
end
```
ã®ã‚ˆã†ãªæ§‹é€ ä½“ã‚’å®šç¾©ã™ã‚Œã°è‰¯ã„ã§ã™ãŒã€ã“ã®å ´åˆã€(å¤šé‡ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã§`*`ã®methodã‚’è¿½åŠ ã—ãªã„é™ã‚Šã¯)`Point2D`ã«å¯¾ã—ã¦è¡Œåˆ—ã§å¤‰æ›ã‚’è¡Œã†ã“ã¨ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚^[`Point2D<:AbstractVector`ã¨ã™ã‚Œã°ã€ãƒ™ã‚¯ãƒˆãƒ«ã¨è¦‹åšã•ã‚Œã¾ã™ãŒã€æ¼”ç®—ã‚’è‡ªåˆ†ã§å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚]

ãƒ™ã‚¯ãƒˆãƒ«ã¨ã—ã¦ä½¿ãˆã‚‹æ¼”ç®—ã‚’ã™ã¹ã¦è‡ªå‰ã§å®Ÿè£…ã™ã‚‹ã®ã¯å¤§å¤‰ãªã®ã§ã€`Point2D`ã®ä»£ã‚ã‚Šã«`SVector{2, Int64}`ã‚’ä½¿ãˆã°è‰¯ã„ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã£ã¦

* é€šå¸¸ã®é…åˆ—(e.g. `[1,2]`)ã‚ˆã‚Šã¯**é«˜é€Ÿã§**
* è‡ªå‰ã®æ§‹é€ ä½“`Point2D`ã‚ˆã‚Šã¯**è¨˜è¿°é‡ãŒå°‘ãªã„**

ã‚ˆã†ãª2æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ãŒå®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`FieldArray`ã¯`SArray`/`MArray`/`SizedArray`ã¨ç”¨é€”ãŒç•°ãªã‚‹ã®ã§èª¬æ˜ã‚’é¿ã‘ã¦ã„ãŸã®ã§ã™ãŒã€å®Ÿã¯ã“ã®ã‚ˆã†ãªstructã®å®šç¾©ã«ãŠã„ã¦ä¾¿åˆ©ã§ã™ã€‚
```julia
struct Point2D <: FieldVector{2, Float64}
    x::Float64
    y::Float64
end
```
ã®ã‚ˆã†ã«å®šç¾©ã™ã‚Œã°ã€`FieldArray`ã«å®šç¾©ã•ã‚ŒãŸmethodãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ä¾¿åˆ©ã§ã™ã€‚

`SArray`ã¨åŸºæœ¬çš„ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯å¤‰ã‚ã‚‰ãªã„ã¯ãšãªã®ã§ã€`SArray`ã‹`FieldArray`ã‚’ä½¿ã†ã‹ã¯å˜ç´”ã«å¯èª­æ€§ãƒ»å¤‰æ›´å®¹æ˜“æ€§ãªã©ã®è¦³ç‚¹ã‹ã‚‰æ±ºã‚ã‚Œã°è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

## å¹¾ä½•çš„ãªç‚¹ã‚’ä½œã‚‹ã¨ãã«ã‚‚ä¾¿åˆ©
æ•°å­—ã‚’ä¸¦ã¹ãŸã ã‘ã®$n$æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã§ã¯ãªãã€å¹¾ä½•çš„ãªç‚¹ã‚’è¡¨ã™å ´åˆã¯ã€[GeometryBasics.jl](https://github.com/JuliaGeometry/GeometryBasics.jl)ã‹[Meshes.jl](https://github.com/JuliaGeometry/Meshes.jl)ã§å®šç¾©ã•ã‚Œã‚‹`Point`ã‚’ä½¿ã†ã®ãŒä¾¿åˆ©ãªã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚‰ã«ã¯å†…éƒ¨çš„ã«`SVector`ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

## æ¬¡å…ƒãŒæ±ºã¾ã£ãŸéƒ¨åˆ†å‹ã‚’æ–°ã—ãä½œã‚‹ã¨ãã«ã‚‚ä¾¿åˆ©
[Rotations.jl](https://github.com/JuliaGeometry/Rotations.jl)ãŒã“ã‚Œã®ä¾‹ã«ãªã‚Šã¾ã™ã€‚

$M\times N$è¡Œåˆ—ã«å¯¾å¿œã™ã‚‹å›ºå®šé•·é…åˆ—ã®æŠ½è±¡å‹ãŒ`StaticArray{M,N}`ã§ã—ãŸã€‚^[è¦ç´ å‹$T$ã®$M\times N$è¡Œåˆ—ã«å¯¾å¿œã™ã‚‹å›ºå®šé•·é…åˆ—ã®æŠ½è±¡å‹ã¯`StaticArray{M,N,T}`ã§ã™ã€‚]

3æ¬¡å…ƒå›è»¢ã‚’è¡¨ã™è¡Œåˆ—ã¯`Rotation{3,T}`ã¨ã—ã¦ä½œã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯`StaticMatrix{3, 3, T}`ã®éƒ¨åˆ†å‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€å›ºå®šé•·é…åˆ—ã®å‹ã‚’æ–°ã—ãä½œã‚ŠãŸã„å ´åˆã¯`StaticArray`ã®éƒ¨åˆ†å‹ã«ã™ã‚‹ã¨æ§˜ã€…ãªmethodãŒãã®ã¾ã¾ä½¿ãˆã‚‹ã®ã§ä¾¿åˆ©ã«ãªã‚Šã¾ã™ã€‚
