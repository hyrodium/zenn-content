---
title: "Quaternions.jlをメンテナンスしてる話"
emoji: "👩‍👩‍👧‍👧"
type: "tech"
topics:
  - "julia"
  - "math"
published: false
---

# はじめに
四元数(quaternion)$q = w+ix+jy+kz$とは、複素数を拡張したもので、$(i,j,k)$は以下の演算規則を充たします。

$$
\begin{gathered}
ii = jj = kk = -1 \\
ij = k, \quad jk = i, \quad ki = j \\
\end{gathered}
$$

あとは通常の分配法則などを使えば和や積が計算できます。

$$
\begin{aligned}
q_1 + q_2
&= (w_1+ix_1+jy_1+kz_1) + (w_2+ix_2+jy_2+kz_2) \\
&= (w_1+w_2) + i(x_1 + x_2) + j(y_1 + y_2) + k(z_1 + z_2) \\ \\
q_1q_2
&= (w_1+ix_1+jy_1+kz_1) (w_2+ix_2+jy_2+kz_2) \\
&= (w_1w_2-x_1x_2-y_1y_2-z_1z_2)+i(w_1x_2)
\end{aligned}
$$

これを計算できるJuliaのパッケージが[Quaternions.jl](https://github.com/JuliaGeometry/Quaternions.jl)です！
インストールするにはJuliaのREPLで

```
]add Quaternions
```

を実行します。
最初の計算例として以下を実行しましょう。

```julia
julia> using Quaternions

julia> Quaternion(1,2,3,4) + Quaternion(5,6,7,8)
Quaternion{Int64}(6, 8, 10, 12)

julia> Quaternion(1,2,3,4) * Quaternion(5,6,7,8)
Quaternion{Int64}(-60, 12, 30, 24)
```

四元数の応用で最も有名なものは3次元回転だと思います。

# Julia言語コニュニティにおける四元数の利用状況
Julia言語のパッケージの仕組みによってコードの再利用が推奨されていますが、多くのパッケージではQuaternions.jlに依存せずに独自に四元数の型を定義していることが多いようです。

* Makie.jl
* ReferenceFrameRotation.jl

四元数の実装を目的にしたパッケージもいくつか存在します。

* Quaternionic.jl
* SimpleQuaternion.jl

このような車輪の再実装を招いてしまった状況の原因は、Quaternions.jlが適切にメンテナンスされていなかったことにあります。
Quaternions.jlは「パッケージ名が適切すぎること」「JuliaGeometryのOrganizationでメンテナンスされていること」などから、登録時の地位は高く、他のパッケージで決定打になるものが出にくかったこともあります。

2022年2月くらいから私とSethさんがメンテナ権限を貰ってメンテナンスを続けてきました。
最近のv0.7.0をリリースして、Quaternions.jlはようやく使える形に整ってきた感じがあります。
本記事ではQuaternions.jlのメンテナンスでの変更点や教訓などを記述しようと思います。

# 変更点
私が開発に参加したのはv0.4.2辺りからです。
正直に言って

時系列順ではなく、変更点の大小で分類しましょう。

* `norm`フラグの削除
* `Octonion`の削除
* `DualQuaternion`の削除
* `Complex`との互換性の削除

以下では、従来実装に対する問題点を指摘しますが、これは単純な..ものです。
自分の書いた実装の問題点は、間違いにどの程度一般性があるのか不明瞭で記事として書きにくいですが、他の人の書いたコードであれば書きやすいというのもあります。
実際の実装に基づいてアンチパターンを記述するのは良くない気がしますが…既にGitHubの


## `norm`フラグの削除
四元数の一番の応用は3次元回転です。
数学的に言えば...


このフラグは..

**教訓**
* 必須ではないフィールドを構造体に入れるのはやめましょう。
* Baseの実装に類似するものがあれば合わせましょう。(今回は`Base.Complex`)


## `Octonion`の削除
実数→複素数→四元数の拡張の延長に八元数があります。
`Octonion`はこのに八元数を表す型で、従来はQuaternions.jlで提供されていました。

これを削除した理由は以下です。

* 1つのパッケージはなるべく軽量であるべき。特にQuaternions.jlのようなプリミティブなものは。
* `Octonion`を提供したいなら別のOctonions.jlパッケージを用意するべき。
* 四元数と八元数を同時に使いたいことは無いはず

そういう訳で、Octonions.jlが用意された後に`Octonions`は削除になりました。

**教訓**
* パッケージはなるべく小さく作りましょう。
* 「数学的な類似性があるから」というのは同一のパッケージで提供する理由には弱く、実用上の側面から考える方が良いです。

## `DualQuaternion`の削除
実数→複素数→四元数の拡張の延長に八元数があります。
`Octonion`はこのに八元数を表す型で、従来はQuaternions.jlで提供されていました。


**教訓**
* Juliaの型パラメータは便利で、それで代用できるものがあれば使いましょう。


## `Complex`との互換性の削除

**教訓**
* 中途半端な実装はやめましょう。
* テストはちゃんと書いておきましょう。
* 数学的な妥当性の低い実装は避けましょう。


## 他の変更事項




# おわりに
本記事で書きたい内容の要約は[Julia Discourseでのアナウンス](https://discourse.julialang.org/t/ann-quaternions-jl-v0-7-0/91368)にもあります。

今後の開発予定としては

* ChainRules.jlへの対応
* v1.0.0のリリース

などがあります。
開発に協力して下さる方を引き続き募集しておりますので、興味がある人は[Quaternions.jl/issues](https://github.com/JuliaGeometry/Quaternions.jl/issues)を覗いてみて下さい！
