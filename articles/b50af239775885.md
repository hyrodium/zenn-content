---
title: "Juliaã§äºŒé …ä¿‚æ•°ã‚’è¨ˆç®—ã™ã‚‹ï¼(Base.binomialã®å®Ÿè£…è§£èª¬)"
emoji: "ğŸš„"
type: "tech"
topics:
  - "julia"
  - "math"
  - "é«˜é€ŸåŒ–"
  - "äºŒé …ä¿‚æ•°"
published: true
published_at: "2022-07-03 22:47"
---

# ã‚¤ãƒ³ãƒˆãƒ­
[äºŒé …ä¿‚æ•°](https://ja.wikipedia.org/wiki/%E4%BA%8C%E9%A0%85%E4%BF%82%E6%95%B0)$\binom{n}{k}$ã«é–¢ã—ã¦

$$
\begin{aligned}
\binom{n}{k} &= \binom{n-1}{k} + \binom{n-1}{k-1} \\
\binom{0}{k} &= \begin{cases} 1 & (k = 0) \\ 0 & (\text{otherwise}) \end{cases}
\end{aligned}
$$

ãŒæˆã‚Šç«‹ã¤ã®ã§ã€ã“ã‚Œã‚’Juliaã§è¨ˆç®—ã™ã‚‹ã«ã¯
```julia
function my_binomial(n,k)
    if n == k == 0
        1
    elseif n == 0
        0
    else
        my_binomial(n-1,k) + my_binomial(n-1,k-1)
    end
end
```
ã¨ã—ã¦é–¢æ•°`my_binomial`ã‚’å®šç¾©ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
Juliaã«ã¯å…ƒã‹ã‚‰`binomial`ãŒå‚™ã‚ã£ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦æ¤œç®—ãŒã§ãã¾ã™ã€‚
```julia
julia> my_binomial(12,4)
495

julia> binomial(12,4)
495
```
åˆã£ã¦ã¾ã™ã­ã€‚ã“ã‚Œã‚‰ã®é•ã„ã¯ä½•ã§ã—ã‚‡ã†ã‹?
[BenchmarkTools.jl](https://github.com/JuliaCI/BenchmarkTools.jl)ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```julia
julia> using BenchmarkTools

julia> @benchmark my_binomial(12,4)
BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min â€¦ max):  12.291 Î¼s â€¦  38.621 Î¼s  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     13.410 Î¼s               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   13.527 Î¼s Â± 587.929 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                       â–„â–† â–ˆ                                     
  â–‚â–â–‚â–â–‚â–â–â–â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–â–„â–†â–†â–ˆâ–ˆâ–ˆâ–â–ˆâ–„â–â–†â–‡â–…â–…â–†â–„â–â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–â–‚â–‚â–‚ â–ƒ
  12.3 Î¼s         Histogram: frequency by time         15.2 Î¼s <

 Memory estimate: 0 bytes, allocs estimate: 0.

julia> @benchmark binomial(12,4)
BenchmarkTools.Trial: 10000 samples with 998 evaluations.
 Range (min â€¦ max):  12.176 ns â€¦ 23.933 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     13.506 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   13.585 ns Â±  0.541 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                       â–„â–„ â–…â–ˆ    â–‚                              
  â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–ƒâ–â–…â–ˆâ–ˆâ–â–ˆâ–ˆâ–„â–â–†â–ˆâ–ˆâ–â–‡â–…â–ƒâ–â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–‚â–â–‚â–‚â–‚ â–ƒ
  12.2 ns         Histogram: frequency by time        15.3 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
ã©ã¡ã‚‰ã‚‚åŒã˜ãã‚‰ã„â€¦ã¨æ€ã„ãã‚„ `13.527 Î¼s` ã¨ `13.585 ns` ãªã®ã§1000å€ã®é€Ÿåº¦å·®ãŒã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯`binomial`ã®å®Ÿè£…ã‚’é€šã˜ã¦

* é«˜é€Ÿãªã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹
* ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œã—ãŸæ›¸ãæ–¹
* æ±ç”¨çš„(æ§˜ã€…ãªå‹ã«å¯¾å¿œå¯èƒ½)ãªæ›¸ãæ–¹

ã«ã¤ã„ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

# å®Ÿè¡Œç’°å¢ƒ
æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

```julia
julia> versioninfo()
Julia Version 1.7.3
Commit 742b9abb4d (2022-05-06 12:58 UTC)
Platform Info:
  OS: Linux (x86_64-pc-linux-gnu)
  CPU: AMD Ryzen 7 4700U with Radeon Graphics
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-12.0.1 (ORCJIT, znver2)
```

# `Base`ã§ã®å®Ÿè£…ã®ç¢ºèª
Juliaã®`@less`ãƒã‚¯ãƒ­ã‚’ä½¿ãˆã°`Base.binomial`ãŒã©ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã§ãã¾ã™ã€‚
```julia
julia> @less binomial(12,4)
```

è¡¨ç¤ºçµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚
```julia
function binomial(n::T, k::T) where T<:Integer
    n0, k0 = n, k
    k < 0 && return zero(T)
    sgn = one(T)
    if n < 0
        n = -n + k -1
        if isodd(k)
            sgn = -sgn
        end
    end
    k > n && return zero(T)
    (k == 0 || k == n) && return sgn
    k == 1 && return sgn*n
    if k > (n>>1)
        k = (n - k)
    end
    x::T = nn = n - k + 1
    nn += 1
    rr = 2
    while rr <= k
        xt = div(widemul(x, nn), rr)
        x = xt % T
        x == xt || throw(OverflowError("binomial($n0, $k0) overflows"))
        rr += 1
        nn += 1
    end
    convert(T, copysign(x, sgn))
end
```

GitHubã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ä»¥ä¸‹ãŒè©²å½“ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãªã‚Šã¾ã™ã€‚
https://github.com/JuliaLang/julia/blob/v1.7.3/base/intfuncs.jl#L986-L1047


# å®Ÿè£…ã®è§£èª¬

## é«˜é€ŸåŒ–ã®ãŸã‚ã®æ¼¸åŒ–å¼
å†’é ­ã§ã¯

$$
\binom{n}{k}
=\binom{n-1}{k}+\binom{n-1}{k-1}
$$

ã®æ¼¸åŒ–å¼ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸã€‚

ã“ã®æ¼¸åŒ–å¼ã¯Pascalã®ä¸‰è§’å½¢ã‚’æ‰‹ã§è¨ˆç®—ã™ã‚‹ã¨ãã«ã¯ä¾¿åˆ©ã§ã™ãŒã€ä¸ãˆã‚‰ã‚ŒãŸ$(n,k)$ã«é–¢ã™ã‚‹äºŒé …ä¿‚æ•°$\binom{n}{k}$ã‚’ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§è¨ˆç®—ã™ã‚‹ã®ã«ã¯ã‚ã¾ã‚Šå‘ã„ã¦ã„ã¾ã›ã‚“ã€‚
ä»£ã‚ã‚Šã«

$$
\binom{n}{k}
=\binom{n-1}{k-1}\cdot \frac{n}{k}
$$

ã®æ¼¸åŒ–å¼ã‚’ä½¿ã†ã¨ä¾¿åˆ©ã§ã™ã€‚[^1]

[^1]: ã“ã®å¼ã«ã¤ã„ã¦ã¯tsujimotterã•ã‚“ã®è§£èª¬ã®[äºŒé …ä¿‚æ•°ã‚’æ±‚ã‚ã‚‹é–¢æ•°ã®ä½œã‚Šæ–¹ (Rubyç·¨)](https://tsujimotter.hatenablog.com/entry/ruby-binomial-coefficient)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```julia
function my_binomial2(n,k)
    if k == 0
        1
    elseif k == n
        1
    elseif 1 â‰¤ k â‰¤ n-1
        my_binomial2(n-1,k-1)*n/k
    else
        0
    end
end
```
æ¤œç®—ã¨ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã™ã€‚
```julia
julia> my_binomial2(12,4)
495.0

julia> @benchmark my_binomial2(12,4)
BenchmarkTools.Trial: 10000 samples with 998 evaluations.
 Range (min â€¦ max):  17.985 ns â€¦ 32.471 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     19.524 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   19.542 ns Â±  0.732 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                  â–   â–…â–ˆâ–…â–‡                                     
  â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–ƒâ–„â–†â–ˆâ–‡â–†â–„â–ˆâ–ˆâ–ˆâ–ˆâ–†â–„â–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚ â–ƒ
  18 ns           Histogram: frequency by time        22.2 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
 ```
* `my_binomial2`ã¯`my_binomial`ã«æ¯”ã¹ã¦ã‹ãªã‚Šé«˜é€Ÿã«ãªã‚Šã¾ã—ãŸï¼ã¾ã `binomial`ã«ã¯é ã„ã§ã™ã­ã€‚
* `my_binomial2(12,4)`ã¯å€¤ã¨ã—ã¦æ­£ã—ã„ã§ã™ãŒæµ®å‹•å°æ•°ç‚¹æ•°ã®495.0ã«ãªã£ã¦ã„ã¾ã™ã€‚

## å‹å®‰å®šãªé™¤ç®—
æ•´æ•°åŒå£«ã®`/`ã¯æµ®å‹•å°æ•°ç‚¹æ•°ã‚’è¿”ã—ã¾ã™ã€‚ä»Šå›ã¯é™¤ç®—ã®çµæœãŒæ•´æ•°ã«ãªã‚‹ã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ã‚‹ã®ã§ã€`div`ã‚’ä½¿ã£ãŸã»ã†ãŒè‰¯ã„ã§ã™ã€‚
```julia
function my_binomial3(n,k)
    k == 0 && return 1
    k == n && return 1
    1 â‰¤ k â‰¤ n-1 && return div(my_binomial3(n-1,k-1)*n, k)
    return 0
end
```
Juliaã§ã¯è«–ç†å’Œ(`|`, `||`)ã¨è«–ç†ç©(`&`,`&&`)ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
1æ–‡å­—ã®`|`,`&`ã¯é–¢æ•°ã§ã™ãŒã€2æ–‡å­—ã®`||`,`&&`ã¯åˆ¶å¾¡å¥ãªã®ã§`if...end`ã®ä»£ã‚ã‚Šã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
é«˜é€ŸåŒ–ã«ã¯å¯„ä¸ã—ã¾ã›ã‚“ãŒã€Baseã®å®Ÿè£…ã«åˆã‚ã›ã‚‹ãŸã‚ã«`if`ã®ä»£ã‚ã‚Šã«ä½¿ã£ã¦ã„ã¾ã™ã€‚

```julia
julia> @benchmark my_binomial3(12,4)
BenchmarkTools.Trial: 10000 samples with 998 evaluations.
 Range (min â€¦ max):  15.605 ns â€¦ 29.181 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     17.145 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   17.119 ns Â±  0.726 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                    â–‚    â–ˆâ–ˆâ–†â–†                                  
  â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–ƒâ–â–ƒâ–ƒâ–ƒâ–‚â–‚â–ƒâ–†â–‡â–ˆâ–â–ˆâ–†â–†â–ˆâ–ˆâ–ˆâ–ˆâ–†â–„â–â–ƒâ–ƒâ–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚ â–ƒ
  15.6 ns         Histogram: frequency by time        19.3 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
åƒ…ã‹ã«é«˜é€ŸåŒ–ã•ã‚Œã¾ã—ãŸï¼( `19.542 ns` â†’ `17.119 ns` )
`Base`å®Ÿè£…ã§ã® `13.585 ns` ã«ã¯ã¾ã è¶³ã‚Šãªã„ã®ã§ã€ä»–ã®ç®‡æ‰€ã§ã¾ã ã¾ã æ”¹å–„ã§ããã†ã§ã™ã­ã€‚

ã¡ãªã¿ã«ã€å‹ä¸å®‰å®šæ€§ã¯`@code_warntype`ãƒã‚¯ãƒ­ã§ç¢ºèªã§ãã¾ã™ã€‚
```julia
julia> @code_warntype my_binomial2(12,4)
MethodInstance for my_binomial2(::Int64, ::Int64)
  from my_binomial2(n, k) in Main at REPL[10]:1
Arguments
  #self#::Core.Const(my_binomial2)
  n::Int64
  k::Int64
Locals
  @_4::Bool
Body::Union{Float64, Int64}
1 â”€â”€ %1  = (k == 0)::Bool
â””â”€â”€â”€       goto #3 if not %1
2 â”€â”€       return 1
3 â”€â”€ %4  = (k == n)::Bool
â””â”€â”€â”€       goto #5 if not %4
4 â”€â”€       return 1
5 â”€â”€ %7  = (1 â‰¤ k)::Bool
â””â”€â”€â”€       goto #7 if not %7
6 â”€â”€ %9  = (n - 1)::Int64
â”‚          (@_4 = k â‰¤ %9)
â””â”€â”€â”€       goto #8
7 â”€â”€       (@_4 = false)
8 â”„â”€       goto #10 if not @_4
9 â”€â”€ %14 = (n - 1)::Int64
â”‚    %15 = (k - 1)::Int64
â”‚    %16 = Main.my_binomial2(%14, %15)::Union{Float64, Int64}
â”‚    %17 = (%16 * n)::Union{Float64, Int64}
â”‚    %18 = (%17 / k)::Float64
â””â”€â”€â”€       return %18
10 â”€       return 0


julia> @code_warntype my_binomial3(12,4)
MethodInstance for my_binomial3(::Int64, ::Int64)
  from my_binomial3(n, k) in Main at REPL[13]:1
Arguments
  #self#::Core.Const(my_binomial3)
  n::Int64
  k::Int64
Locals
  @_4::Bool
Body::Int64
1 â”€â”€ %1  = (k == 0)::Bool
â””â”€â”€â”€       goto #3 if not %1
2 â”€â”€       return 1
3 â”€â”€ %4  = (k == n)::Bool
â””â”€â”€â”€       goto #5 if not %4
4 â”€â”€       return 1
5 â”€â”€ %7  = (1 â‰¤ k)::Bool
â””â”€â”€â”€       goto #7 if not %7
6 â”€â”€ %9  = (n - 1)::Int64
â”‚          (@_4 = k â‰¤ %9)
â””â”€â”€â”€       goto #8
7 â”€â”€       (@_4 = false)
8 â”„â”€       goto #10 if not @_4
9 â”€â”€ %14 = (n - 1)::Int64
â”‚    %15 = (k - 1)::Int64
â”‚    %16 = Main.my_binomial3(%14, %15)::Int64
â”‚    %17 = (%16 * n)::Int64
â”‚    %18 = Main.div(%17, k)::Int64
â””â”€â”€â”€       return %18
10 â”€       return 0
```
å°‘ã—é•·ã„ã§ã™ãŒã€`my_binomial2(12,4)`ã®`Body::Union{Float64, Int64}`ãŒå‹ä¸å®‰å®šã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
zennã«å®Ÿè¡Œçµæœã‚’è²¼ã‚Šä»˜ã‘ã¦ã„ã‚‹ã ã‘ãªã®ã§åˆ†ã‹ã‚Šã«ãã„ã§ã™ãŒã€REPLã§å®Ÿè¡Œã™ã‚Œã°å‹ä¸å®‰å®šãªç®‡æ‰€ã‚’èµ¤æ–‡å­—ã§è¡¨ç¤ºã—ã¦ãã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/7dd05f903ec9-20220703.png)

## å†å¸°å‘¼ã³å‡ºã—ã‚’é¿ã‘ã‚‹
```julia
function my_binomial4(n,k)
    k == 0 && return 1
    k == n && return 1
    1 â‰¤ k â‰¤ n-1 || return 0
    x = 1
    for _k in 1:k
        _n = n - k + _k
        x = div(x*_n, _k)
    end
    return x
end
```

```julia
julia> my_binomial4(12,4)
495

julia> @benchmark my_binomial4(12,4)
BenchmarkTools.Trial: 10000 samples with 1000 evaluations.
 Range (min â€¦ max):  0.978 ns â€¦ 16.552 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     2.375 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   2.386 ns Â±  0.409 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                                            â–ˆ                 
  â–‚â–â–â–â–â–â–â–â–â–â–â–â–‚â–â–â–‚â–â–â–â–â–â–â–â–â–â–‚â–â–ƒâ–â–â–ƒâ–â–â–â–â–â–â–â–‚â–â–…â–â–ˆâ–â–â–‡â–â–â–â–â–â–â–â–‚â–â–ƒâ–â–ƒ â–‚
  0.978 ns       Histogram: frequency by time        2.86 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```

`17.119 ns` â†’ `2.386 ns` ã«ãªã£ã¦å¤§å¹…ã«é«˜é€ŸåŒ–ã§ãã¾ã—ãŸï¼
`Base.binomial`ãŒ 13ns ç¨‹åº¦ã ã£ãŸã®ã§ã€Juliaã®å®Ÿè£…ã‚ˆã‚Šã‚‚é«˜é€Ÿã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã­â€¦ã€‚
ãã†ã„ã†è¨³ã§ã€é«˜é€Ÿãªå®Ÿè£…ãŒæ¬²ã—ã‘ã‚Œã°`Base`ã®é–¢æ•°ã‚’è‡ªåˆ†ã§å†å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚æ™‚ã«ã¯æœ‰ç”¨ã§ã™ã€‚

## ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯¾ç­–
äºŒé …ä¿‚æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

$$
\binom{n}{k} = \frac{n!}{k!(n-k)!}
$$

éšä¹—ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã¯å®¹æ˜“ã«èµ·ã“ã‚‹ã¨äºˆæƒ³ã§ãã¾ã™ã­ã€‚
ç™ºæ•£ã®ã‚ªãƒ¼ãƒ€ãƒ¼ã¯[Stirlingã®å…¬å¼](https://ja.wikipedia.org/wiki/%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E8%BF%91%E4%BC%BC)ãªã©ã§ç¢ºèªã§ãã¾ã™ãŒã€ã“ã“ã§ã¯æ•°å€¤å®Ÿé¨“ã§ç¢ºã‹ã‚ã¾ã—ã‚‡ã†ã€‚
```julia
julia> binomial(0,0)
1

julia> binomial(20,10)
184756

julia> binomial(40,20)
137846528820

julia> binomial(60,30)
118264581564861424

julia> binomial(80,40)
ERROR: OverflowError: binomial(80, 40) overflows
Stacktrace:
 [1] binomial(n::Int64, k::Int64)
   @ Base ./intfuncs.jl:1042
 [2] top-level scope
   @ REPL[63]:1
```
ã¡ã‚ƒã‚“ã¨ã‚¨ãƒ©ãƒ¼ã‚’åã„ã¦ãã‚Œã¾ã™ã­ã€‚
ã—ã‹ã—`my_binomial4`ã§ã¯ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã›ãšã«è² ã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚
```julia
julia> my_binomial4(80,40)
-15097783517027730
```
ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã¦æ­£ã—ã„å€¤ãŒæ¬²ã—ã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`BigInt`ã‚’ä½¿ãˆã°OKã§ã™ã€‚
```julia
julia> my_binomial4(BigInt(80),BigInt(40))
107507208733336176461620

julia> binomial(BigInt(80),BigInt(40))
107507208733336176461620
```
ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«`my_binomial5`ã‚’å®šç¾©ã—ã¾ã™ã€‚
```julia
function my_binomial5(n,k)
    k == 0 && return 1
    k == n && return 1
    1 â‰¤ k â‰¤ n-1 || return 0
    x = 1
    for _k in 1:k
        _n = n - k + _k
        _x = div(widemul(x,_n), _k)  # å‹ã‚’æ‹¡å¼µã—ã¦è¨ˆç®—
        x = _x % Int  # å…ƒã®å‹ã«åã‚ã‚‹
        x == _x || throw(OverflowError("overflow"))
    end
    return x
end
```
ã“ã“ã§
* `widemul(x,_n)`
   * `widemul`ã¯æ›ã‘ç®—
   * ãŸã ã—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã—ãªã„å‹ã‚’é¸ã‚“ã§è¨ˆç®—ã™ã‚‹
   * ä¾‹ãˆã°`widemul(::UInt8,::UInt8)::UInt16`, `widemul(::Int64,::Int64)::UInt128`ãªã©ã§ã™ã€‚
* `x % Int`
   * `%`ã¯ä½™ã‚Šã®è¨ˆç®—ã§ã€ä¾‹ãˆã°`128 % 5`ã¯`3`ã§ã™
   * ç¬¬2å¼•æ•°ã«ã¯æ•´æ•°å‹ã‚’å…¥ã‚Œã‚‹ã“ã¨ã‚‚ã§ãã¦ã€ä¾‹ãˆã°`1729 % Int8`ã¯`-63`ã§ã™

æ¤œç®—ã¨ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’ã—ã¾ã—ã‚‡ã†ï¼
```julia
julia> my_binomial5(12,4)
495

julia> my_binomial5(80,40)
ERROR: OverflowError: overflow
Stacktrace:
 [1] my_binomial5(n::Int64, k::Int64)
   @ Main ./REPL[65]:10
 [2] top-level scope
   @ REPL[67]:1

julia> @benchmark my_binomial5(12,4)
BenchmarkTools.Trial: 10000 samples with 998 evaluations.
 Range (min â€¦ max):  15.745 ns â€¦ 31.072 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     17.145 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   17.168 ns Â±  0.632 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                       â–ˆ â–ˆâ–…â–†                                   
  â–‚â–‚â–‚â–‚â–â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–â–„â–†â–ˆâ–‡â–†â–†â–ˆâ–â–ˆâ–ˆâ–ˆâ–†â–„â–ƒâ–â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–‚â–‚ â–ƒ
  15.7 ns         Histogram: frequency by time        19.3 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
ä½•æ•…ã‹`binomial(12,4)`ã®13nsã‚ˆã‚Šã‚‚é…ããªã£ã¡ã‚ƒã„ã¾ã—ãŸã­ã€‚

## åˆæœŸå€¤å¤‰æ›´ã§é«˜é€ŸåŒ–
å…ˆã«ãƒã‚¿ãƒãƒ¬ã™ã‚‹ã¨ã€1å›`x == _x || throw(OverflowError("overflow"))`ã‚’å®Ÿè¡Œã™ã‚‹ãŸã³ã« 4ns ç¨‹åº¦æ›ã‹ã£ã¦ã„ã¾ã™ã€‚
`my_binomial5(12,4)`ã®è¨ˆç®—ã§ã¯ã€Œ`my_binomial5(11,4)` â†’ `my_binomial5(10,3)` â†’ `my_binomial5(9,2)` â†’ `my_binomial5(8,1)` â†’ `my_binomial5(7,0) == 0`ã€ã®4å›ã§åˆè¨ˆ 16ns ãã‚‰ã„æ›ã‹ã‚Šã¾ã™ã€‚
$n \ge 0$ã®æ•´æ•°ã«å¯¾ã—ã¦ä¸€èˆ¬ã«

$$
\binom{n}{1} = n
$$

ãªã®ã§ã€ã“ã‚Œã‚’ä½¿ãˆã°å°‘ã—é«˜é€ŸåŒ–ã§ããã†ã§ã™ã€‚ã¤ã¾ã‚Š`my_binomial5(12,4)`ã®ã‚±ãƒ¼ã‚¹ã§ã¯ `my_binomial5(8,1) == 8` ã¯è‡ªæ˜ãªã®ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãƒã‚§ãƒƒã‚¯ã®å›æ•°ã‚’1å›æ¸›ã‚‰ã›ãã†ã§ã™ã€‚
```julia
function my_binomial6(n,k)
    k == 0 && return 1
    k == n && return 1
    1 â‰¤ k â‰¤ n-1 || return 0
    x = n - k + 1  # åˆæœŸå€¤ã‚’1ã‹ã‚‰å¤‰æ›´
    for _k in 2:k  # _kã®ç¯„å›²ã‚’2ã‹ã‚‰ã«å¤‰æ›´
        _n = n - k + _k
        _x = div(widemul(x,_n), _k)
        x = _x % Int
        x == _x || throw(OverflowError("overflow"))
    end
    return x
end
```
ã“ã‚Œã§ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
```julia
julia> my_binomial6(12,4)
495

julia> my_binomial6(80,40)
ERROR: OverflowError: overflow
Stacktrace:
 [1] my_binomial6(n::Int64, k::Int64)
   @ Main ./REPL[69]:10
 [2] top-level scope
   @ REPL[71]:1

julia> @benchmark my_binomial6(12,4)
BenchmarkTools.Trial: 10000 samples with 999 evaluations.
 Range (min â€¦ max):  11.954 ns â€¦ 46.631 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     13.423 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   13.768 ns Â±  1.861 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

   â–â–ƒ â–ƒâ–„â–…â–ˆâ–‡â–†â–… â–    â–                                          â–‚
  â–†â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–†â–‡â–ˆâ–‡â–ˆâ–‡â–„â–â–â–â–â–„â–â–â–ƒâ–ƒâ–ƒâ–ƒâ–…â–â–„â–„â–„â–ƒâ–„â–â–ƒâ–„â–ƒâ–ƒâ–â–ƒâ–ƒâ–…â–†â–†â–„â–‡â–†â–†â–‡â–…â–†â–†â–ˆâ–ˆ â–ˆ
  12 ns        Histogram: log(frequency) by time      23.1 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
`Base`ã®`binomial(12,4)`ã¨åŒç¨‹åº¦ã®é€Ÿåº¦ã«ãªã‚Šã¾ã—ãŸï¼

## å¯¾ç§°æ€§ã‚’ä½¿ã£ãŸé«˜é€ŸåŒ–
ä»¥ä¸‹ã¯ã©ã¡ã‚‰ã‚‚åŒã˜å€¤ã§ã™ãŒ
```julia
julia> my_binomial6(12,4)
495

julia> my_binomial6(12,8)
495
```
ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã‚‹ã¨å¾Œè€…ã®æ–¹ãŒé…ã„ã§ã™ã€‚
```julia
julia> @benchmark my_binomial6(12,8)
BenchmarkTools.Trial: 10000 samples with 995 evaluations.
 Range (min â€¦ max):  22.111 ns â€¦ 61.348 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     29.691 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   29.938 ns Â±  1.732 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                          â–ƒâ–‚â–…â–…â–ˆâ–…â–„â–   â– â–                      â–
  â–ƒâ–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–†â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–†â–ˆâ–‡â–ˆâ–‡â–ˆâ–†â–ˆâ–ˆâ–‡â–…â–â–„â–ƒâ–„â–â–â–†â–…â–‡â–ƒâ–†â–…â–†â–†â–†â–† â–ˆ
  22.1 ns      Histogram: log(frequency) by time      37.9 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
$n \ge 0$ã®æ•´æ•°ã«å¯¾ã—ã¦ä¸€èˆ¬ã«ä»¥ä¸‹ãŒæˆç«‹ã—ã¾ã™ã€‚

$$
\binom{n}{k} = \binom{n}{n-k}
$$

ã‚ˆã£ã¦ã€$k \le n/2$ã‚’æº€ãŸã™ã‚ˆã†ãª`k`ã‚’é¸ã¶ã‚ˆã†ã«ã™ã‚Œã°é«˜é€ŸåŒ–ãŒã§ããã†ã§ã™ã€‚

```julia
function my_binomial7(n,k)
    k == 0 && return 1
    k == n && return 1
    1 â‰¤ k â‰¤ n-1 || return 0
    if div(n,2) < k
        k = n - k  # kãŒå¤§ãã‘ã‚Œã°n-kã«ç½®ãæ›ãˆ
    end
    x = n - k + 1
    for _k in 2:k
        _n = n - k + _k
        _x = div(widemul(x,_n), _k)
        x = _x % Int
        x == _x || throw(OverflowError("overflow"))
    end
    return x
end
```
ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¨ã‚Šã¾ã—ã‚‡ã†ï¼
```julia
julia> my_binomial7(12,4)
495

julia> my_binomial7(12,8)
495

julia> @benchmark my_binomial7(12,4)
BenchmarkTools.Trial: 10000 samples with 999 evaluations.
 Range (min â€¦ max):  11.885 ns â€¦ 53.481 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     13.492 ns              â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   13.595 ns Â±  0.718 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                          â–„â–„â–†â–ˆ   â–â–ƒ                            
  â–‚â–â–â–â–‚â–â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–„â–…â–â–ˆâ–ˆâ–ˆâ–ˆâ–…â–â–‡â–ˆâ–ˆâ–ˆâ–†â–â–„â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚â–â–‚â–‚â–‚â–‚â–‚ â–ƒ
  11.9 ns         Histogram: frequency by time        15.3 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.

julia> @benchmark my_binomial7(12,8)
BenchmarkTools.Trial: 10000 samples with 999 evaluations.
 Range (min â€¦ max):  11.884 ns â€¦ 152.683 ns  â”Š GC (min â€¦ max): 0.00% â€¦ 0.00%
 Time  (median):     13.492 ns               â”Š GC (median):    0.00%
 Time  (mean Â± Ïƒ):   13.704 ns Â±   3.768 ns  â”Š GC (mean Â± Ïƒ):  0.00% Â± 0.00%

                           â–…â–†â–ˆ   â–â–ƒ                             
  â–‚â–‚â–‚â–‚â–‚â–â–‚â–ƒâ–ƒâ–ƒâ–ƒâ–â–‚â–‚â–‚â–ƒâ–ƒâ–â–ƒâ–ƒâ–ƒâ–„â–†â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–†â–ƒâ–…â–ˆâ–ˆâ–ˆâ–†â–‚â–„â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚ â–ƒ
  11.9 ns         Histogram: frequency by time         15.4 ns <

 Memory estimate: 0 bytes, allocs estimate: 0.
```
`my_binomial7(12,4)`ã®é€Ÿåº¦ã‚’è½ã¨ã•ãšã«`my_binomial7(12,8)`ã®é«˜é€ŸåŒ–ãŒã§ãã¾ã—ãŸï¼


## è¤‡æ•°ã®æ•´æ•°å‹ã¸ã®å¯¾å¿œ
`Int32`ã®å…¥åŠ›ã«å¯¾ã—ã¦ã¯`Int32`ã‚’è¿”ã—ã¦ã»ã—ã„ã§ã™ãŒã€ç¾çŠ¶ã®`my_binomial7`ã§ã¯ãã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚
```julia
julia> my_binomial7(Int32(12),Int32(4)) |> typeof
Int64

julia> binomial(Int32(12),Int32(4)) |> typeof
Int32
```
ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°OKã§ã™ã€‚
```julia
function my_binomial8(n::T, k::T) where T<:Integer
    k == 0 && return one(T)  # one(T)ã¯å‹Tã®ä¹—æ³•å˜ä½å…ƒã‚’è¿”ã™é–¢æ•°
    k == n && return one(T)
    1 â‰¤ k â‰¤ n-1 || return zero(T)  # zero(T)ã¯å‹Tã®åŠ æ³•å˜ä½å…ƒã‚’è¿”ã™é–¢æ•°
    if div(n,2) < k
        k = n - k
    end
    x = n - k + one(T)
    for _k in 2:k
        _n = n - k + _k
        _x = div(widemul(x,_n), _k)
        x = _x % T
        x == _x || throw(OverflowError("overflow"))
    end
    return x
end
```
æˆ»ã‚Šå€¤ã®å‹ã‚‚æœŸå¾…é€šã‚Šã§ã€å¼•æ•°ã®å‹ã«å¿œã˜ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚‚æ­£ã—ãæ¤œçŸ¥ã§ãã¦ã„ã¾ã™ã­ã€‚
```julia
julia> my_binomial8(Int32(12), Int32(4))
495

julia> my_binomial8(Int32(12), Int32(4)) |> typeof
Int32

julia> my_binomial8(Int8(12),Int8(4))
ERROR: OverflowError: overflow
Stacktrace:
 [1] my_binomial8(n::Int8, k::Int8)
   @ Main ./REPL[23]:13
 [2] top-level scope
   @ REPL[30]:1
```

##  $n$ãŒè² ã®äºŒé …ä¿‚æ•°
$\binom{n}{k}$ã«ãŠã„ã¦$n$ãŒè² ã®æ•´æ•°ã§ã‚ã£ã¦ã‚‚äºŒé …ä¿‚æ•°ã¯å®šç¾©ã•ã‚Œã¾ã™ã€‚
```julia
julia> binomial(-1,3)
-1

julia> binomial(-2,3)
-4
```
ã¾ã `my_binomial8`ã¯å¯¾å¿œã§ãã¦ã„ãªã„ã§ã™ã­ã€‚
```julia
julia> my_binomial8(-1,3)
0

julia> my_binomial8(-2,3)
0
```
ä»¥ä¸‹ã®ç­‰å¼ã‚’æº€ãŸã™ä¿‚æ•°ã‚’äºŒé …ä¿‚æ•°ã¨å®šç¾©ã™ã‚Œã°ã€$n$ãŒè² ã®å ´åˆã®äºŒé …ä¿‚æ•°ã‚‚å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

$$
(1+x)^n
= \sum_{i=-\infty}^\infty \binom{n}{k} x^k
$$

ä¾‹ãˆã°ã€$n=-1$ã«å¯¾ã—ã¦ã¯

$$
\frac{1}{1+x}
= 1 - x + x^2 -x^3 + x^4 - x^5 + \cdots
$$

ã®Maclaurinå±•é–‹ã«ã‚ˆã£ã¦äºŒé …ä¿‚æ•°ã‚’è¨ˆç®—ã§ãã¾ã™ã€‚[^2]
[^2]: $n \ge 0$ã®æ•´æ•°ã«å¯¾ã—ã¦$\sum_{k}\binom{n}{k} = 2^n$ãŒæˆã‚Šç«‹ã¡ã¾ã™ã€‚$1-1+1-1+\cdots$ã®ç´šæ•°ã¯$1/2$ã«ãªã‚‹ã®ã§ã€$n=-1$ã«å¯¾ã—ã¦ã‚‚$\sum_{k}\binom{n}{k} = 2^n$ãŒæˆã‚Šç«‹ã£ã¦ã„ã¦é¢ç™½ã„ã§ã™ã­ã€‚([ã‚°ãƒ©ãƒ³ãƒ‡ã‚£ç´šæ•°](https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%A9%E3%83%B3%E3%83%87%E3%82%A3%E7%B4%9A%E6%95%B0))

`Base.binomial`ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ­£ã—ãè¨ˆç®—ãŒã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
```julia
julia> binomial.(-1,0:5)
6-element Vector{Int64}:
  1
 -1
  1
 -1
  1
 -1
```
ã“ã“ã§ã¯ã“ã‚Œä»¥ä¸Šç«‹ã¡å…¥ã‚Šã¾ã›ã‚“ãŒã€`Base`ã§ã®å®šç¾©ã§ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®å‘¨è¾ºãŒè©²å½“ã™ã‚‹ç®‡æ‰€ã«ãªã‚Šã¾ã™ã€‚

https://github.com/JuliaLang/julia/blob/v1.7.3/base/intfuncs.jl#L1024-L1029

## `Base`ã®å®Ÿè£…ã¨ã®å·®ç•°
ã“ã‚Œã¾ã§ã®è§£èª¬ã§ã€ã»ã¼`Base`ã®å®Ÿè£…ã‚’å†ç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ã¾ã é•ã„ãŒæ®‹ã£ã¦ã„ã¾ã™ãŒã€ã‚ã¨ã¯ç´°ã‹ã„éƒ¨åˆ†ã§ã™ã€‚

* `Base`å®Ÿè£…ã®`rr`ã¯`my_binomial8`ã®`_k`ã«ç›¸å½“
* `Base`å®Ÿè£…ã®`nn`ã¯`my_binomial8`ã®`_n`ã«ç›¸å½“
* `Base`ã§ã¯`for`ã®ä»£ã‚ã‚Šã«`while`ã‚’ä½¿ã£ã¦ã„ã‚‹
* `Base`ã§ã¯`div(n,2)`ã®ä»£ã‚ã‚Šã«ãƒ“ãƒƒãƒˆã‚·ãƒ•ãƒˆæ¼”ç®—`n>>1`ã‚’ä½¿ã£ã¦ã„ã‚‹

# ã¾ã¨ã‚
* Juliaã®`Base.binomial`ã®å®Ÿè£…ã‚’ã»ã¼å†ç¾ã§ãã¾ã—ãŸã€‚
* ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’è«¦ã‚ã‚Œã°ã€`Base.binomial`ã‚’ã‚ˆã‚Šé«˜é€ŸåŒ–ã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
* äºŒé …ä¿‚æ•°ã¯æ­£è¦åˆ†å¸ƒã‚’ä½¿ã£ã¦è¿‘ä¼¼ã™ã‚‹ã“ã¨ãŒã§ãã‚‹[^3]ãŸã‚ã€ã“ã‚Œã‚’ä½¿ãˆã°`Base.binomial`ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã®ãƒã‚§ãƒƒã‚¯å›æ•°ã‚’æ¸›ã‚‰ã—ã¦å¤§å¹…ã«é«˜é€ŸåŒ–ã§ãã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚

[^3]: è©³ã—ãã¯[äºŒé …åˆ†å¸ƒã®æ­£è¦è¿‘ä¼¼ï¼ˆãƒ©ãƒ—ãƒ©ã‚¹ã®å®šç†ï¼‰](https://manabitimes.jp/math/1107)ã‚’å‚ç…§ã—ã¦ãã ã•ã„





